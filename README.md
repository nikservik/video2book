# Video2Book

Серверное приложение для обработки лекций: проекты, уроки, версии пайплайнов, очереди прогонов и интеграции с LLM-провайдерами.

Текущая целевая архитектура: **Laravel + Livewire** (без desktop-клиента).

## Что делает приложение

- Управляет проектами и уроками.
- Хранит версионируемые пайплайны и шаги.
- Запускает обработку уроков через очередь `pipelines`.
- Поддерживает транскрибацию и текстовые шаги через OpenAI / Anthropic / Gemini.
- Считает usage и стоимость по каждому шагу.
- Экспортирует результаты шагов в PDF/Markdown/DOCX.
- Поддерживает загрузку уроков по YouTube-ссылке через `yt-dlp`.
- Ведёт журнал действий пользователей по проектам, урокам и прогонам с привязкой к пользователю и объекту.
- Использует soft delete для пользователей, проектов, уроков и прогонов.

## Технологии

- PHP 8.4+
- Laravel 12
- Queue (database driver по умолчанию)
- Blade + Vite
- Livewire (целевая серверная UI-архитектура)
- Laravel AI SDK (`laravel/ai`) как единый слой для OpenAI / Anthropic / Gemini
- `protonemedia/laravel-ffmpeg` и `norkunas/youtube-dl-php`
- `barryvdh/laravel-dompdf` для PDF-экспорта (HTML/CSS)
- `spatie/laravel-activitylog` для аудита действий пользователей

## Быстрый старт

### 1. Установка

```bash
composer install
cp .env.example .env
php artisan key:generate
php artisan migrate
pnpm install
```
На Forge выполнить рецепт `WARP proxy`.
В папку `shared/storage` добавить папку `fonts` для кеша шрифтов pdf.

### 2. Обязательные `.env` переменные

Минимум:

- `OPENAI_API_KEY`
- `ANTHROPIC_API_KEY` (если используете Anthropic)
- `GEMINI_API_KEY` (если используете Gemini)

Полезные настройки:

- `LLM_REQUEST_TIMEOUT=1800`
- `LLM_ANTHROPIC_MAX_TOKENS=64000`
- `YTDLP_BINARY=yt-dlp`
- `YT_PROXY=` (на сервере обязательно через WARP `http://127.0.0.1:1080`)
- `QUEUE_CONNECTION=database`
- `SIMPLE_AUTH_EMAIL=team@local`
- `SIMPLE_AUTH_COOKIE_NAME=video2book_access_token`

### 3. Запуск разработки

В одном окне:

```bash
composer dev
```

Или отдельными процессами:

```bash
php artisan serve
php artisan queue:listen --tries=1 --queue=pipelines
pnpm dev
```

### 4. Доступ в веб-интерфейс (invite)

- Доступ в web-layer работает по invite-токену в cookie.
- После миграции создаётся пользователь `team@local` с `access_level=2` (superadmin).
- Уровни доступа:
  - `0` — пользователь: `Главная`, `Проекты`.
  - `1` — админ: дополнительно `Шаблоны`, `Пользователи`, `Активность`.
  - `2` — суперадмин: права админа + видимость своей superadmin-карточки в управлении пользователями.
- Чтобы выдать новый invite (например, через Forge), выполните:

```bash
php artisan auth:generate-invite
```

- Чтобы показать текущий invite без ротации токена:

```bash
php artisan auth:show-invite
```

- Команда выводит готовую ссылку вида `https://.../invite/{token}`.
- `auth:generate-invite` создаёт (или обновляет) `team@local` как superadmin и ротирует токен.
- `auth:show-invite` показывает текущий invite superadmin без ротации токена.
- После перехода по ссылке браузер получает постоянный cookie и редиректится на главную.
- Проверка invite-cookie выполняется middleware `AuthenticateTeamAccessToken` в `web` group, поэтому авторизация стабильно действует и на Livewire update-запросах.

## Архитектура репозитория

- `app/Http/Controllers` — API-контроллеры.
- `app/Jobs` — фоновые задания.
- `app/Models` — Eloquent-модели.
- `app/Services/Lesson` — загрузка/подготовка медиа.
- `app/Services/Pipeline` — запуск шагов, статусы, экспорт.
- `app/Services/Llm` — интеграция с Laravel AI SDK, usage/cost и лимиты.
- `routes/api.php` — REST API.
- `routes/web.php` — веб-маршруты для серверного UI.
- `resources/views` — Blade-шаблоны.
- `tests/Feature`, `tests/Unit` — покрытие API/сервисов.

## Доменные сущности

- `Project` — контейнер уроков.
- `Lesson` — единица обработки (источник + настройки).
- `Pipeline` / `PipelineVersion` — версия сценария обработки.
- `Step` / `StepVersion` — шаги версии пайплайна.
- `PipelineRun` / `PipelineRunStep` — фактический прогон и шаги выполнения.
- `ProjectTag` — теги проектов/уроков.

## API (основное)

- `GET/POST/PUT /api/projects`
- `POST /api/projects/youtube`
- `GET/POST/PUT /api/lessons`
- `POST /api/lessons/{lesson}/audio`
- `POST /api/lessons/{lesson}/download`
- `GET/POST/PUT /api/pipelines`
- `GET /api/pipeline-versions/{id}/steps`
- `GET/POST /api/pipeline-runs`
- `POST /api/pipeline-runs/{run}/restart`
- `GET /api/pipeline-runs/{run}/steps/{step}/export/pdf`
- `GET /api/pipeline-runs/{run}/steps/{step}/export/md`
- `GET /api/pipeline-runs/{run}/steps/{step}/export/docx`

## Livewire-переход

Архитектурное решение на этом этапе: развивать серверный UI на Livewire и использовать существующий доменный/сервисный слой без дублирования логики.

Рекомендованный подход:

1. Строить новые пользовательские сценарии как Livewire-компоненты.
2. Сложные операции оставлять в сервисах и очередях.
3. API сохранять как стабильный контракт для внутренних и внешних клиентов.

Текущий статус UI:
- Базовый серверный layout (`resources/views/layouts/app.blade.php`) уже подключён для web-страниц и содержит верхнюю навигацию, mobile-меню и контентный контейнер.
- В правой части layout используются кнопка настроек (`cog-8-tooth`, heroicons) и переключатель светлой/тёмной темы (адаптация Tailwind UI под Blade/Livewire), который применяет тему ко всей странице.
- Главная страница реализована как full-page Livewire-компонент (`app/Livewire/HomePage.php`) c данными из сервисного query-слоя (`app/Services/Project/RecentProjectsQuery.php`): левая колонка `2/3` показывает блок `Свежие проекты` — 5 последних изменённых проектов в табличном виде (как на странице `Проекты`), где первая колонка — название папки проекта, а колонки `Уроков` и `Длительность` стакаются на mobile (до `md`).
- Правая колонка `1/3` вынесена в отдельный Livewire-компонент (`app/Livewire/Widgets/QueueWidget.php`) и показывает реальную очередь обработки из таблицы `jobs` (обработка пайплайна и скачивание аудио).
- Layout работает в режиме Livewire-only (рендер через `$slot`), без `@yield`-секций для Blade-страниц.
- Livewire views хранятся в `resources/views/pages/*` и `resources/views/widgets/*` (без каталога `resources/views/livewire`).
- Верхнее меню содержит разделы `Главная`, `Проекты`, `Шаблоны`, `Пользователи`, `Активность`; видимость пунктов зависит от `access_level`, а активный пункт определяется по имени роута (`routeIs`).
- В layout между меню и контентом добавлены breadcrumbs (адаптация Tailwind UI): на главной breadcrumbs скрыты, на остальных страницах (`Проекты`, `Проект`, `Урок`, `Шаблоны`, `Шаг шаблона`) путь формируется через параметры `breadcrumbs` в full-page Livewire-компонентах; на мобильных включён перенос в несколько строк с левым сдвигом для 2+ строк, при этом связка `separator-icon + label` не разрывается.
- Основной заголовок страницы (`h1`) рендерится внутри каждого page-шаблона (`resources/views/pages/*`), а не в общем layout.
- Основной layout не содержит встроенных `@php` блоков: конфигурация меню вынесена в `config/navigation.php`, а логика активного пункта и breadcrumbs описана через Blade-выражения.
- Основной текст в шаблонах использует базовый размер по умолчанию (без `text-sm`/`text-base`), уменьшение размера применяется только к второстепенным метаданным.
- Страница `Проекты` отображает папки и вложенные проекты в формате аккордеона: одновременно открыта только одна папка, при переключении предыдущая автоматически сворачивается.
- Для папки добавлены параметры видимости: `hidden` и `visible_for` (массив id пользователей); по умолчанию все папки видимы всем.
- В модалках создания/редактирования папки доступен переключатель `Скрыть папку`; при включении показывается список `Кому папка видна` (сортировка: `access_level DESC`, затем `name`), где `superadmin` и текущий редактор папки отмечены и недоступны для снятия.
- Для открытой папки проекты показываются в таблице (`table-stacked-on-mobile`): колонки `drag-handle`, `Название`, `Уроки`, `Длительность`; на mobile (до `md`) колонки `Уроки` и `Длительность` стакаются в подписи `Уроков: N` и `Длительность: N`.
- Скрытые папки (и проекты внутри них) не выводятся пользователям, чьи id не входят в `visible_for`; правило применяется на странице `Проекты` и в блоке `Свежие проекты` на главной.
- Страница `Шаблоны` отображает все шаблоны в grid на 3 колонки, для каждого показывает название, номер текущей версии и описание текущей версии; в заголовке есть кнопка `Добавить шаблон`, открывающая модал создания с динамическим списком шагов.
- Страница `Пользователи` доступна для `admin/superadmin`: список карточек, добавление/редактирование пользователя, удаление через confirm-модал, генерация нового invite-токена и копирование invite-ссылки.
- Страница `Активность` доступна для `admin/superadmin` и показывает историю `Activity Log` в формате строк (`дата и время`, `пользователь`, `действие`, `тип объекта`, `название объекта`) с пагинацией по 20 записей; для `прогона` название формируется как `Урок — Шаблон • vN`, а для `урока` дописывается проект: `Урок в проекте «Проект»`. В лог попадают только действия с автором-пользователем; системные действия без `causer` не записываются.
- В модалках добавления/редактирования пользователя выбор уровня доступа (`пользователь` / `админ`) сделан переключателем из двух кнопок; для `superadmin` уровень отображается как read-only.
- При ротации invite-токена текущим пользователем в модалке `Пользователь` новый токен сразу записывается в auth-cookie, чтобы доступ не терялся на следующем запросе.
- Карточка superadmin видна только самому superadmin.
- Карточки в списке шаблонов кликабельны и ведут на страницу просмотра шаблона (`pipelines.show`).
- На странице просмотра шаблона отображаются шаги выбранной версии (по умолчанию — текущей версии шаблона), а в правом блоке доступны кнопки `Редактировать версию`, `Сделать текущей версией` (disabled для текущей) и `Архивировать версию`/`Вернуть из архива` (в зависимости от статуса версии), а также переключение между версиями.
- Новая версия шаблона, созданная из модала `Добавить шаблон`, по умолчанию получает статус `archived`, потому что её шаги стартуют в `draft`; возврат из архива доступен только когда в выбранной версии нет шагов со статусом `draft`.
- В модале редактирования шага для `draft`-шага скрыты поле `Описание изменения` и кнопка `Сохранить новая версия`; обычное `Сохранить` обновляет шаг и переводит его в `active`.
- Добавлена сущность `Folder` и связь `projects.folder_id`; миграция создаёт первую папку `Проекты` и переносит в неё существующие проекты.
- На странице `Проекты` в заголовке доступна кнопка `Добавить папку` (модал с единственным полем `Название папки`).
- В строке открытой папки справа доступны действия `Изменить` (модал переименования) и `Добавить проект` (старый модал создания проекта с заголовком `Добавить проект в «{папка}»`); для закрытых папок эти действия скрыты.
- После drag&drop проекта в закрытую папку аккордеон автоматически раскрывает папку назначения.
- Модал создания проекта содержит поля: `Название проекта` (обязательное), `Referer`, `Версия шаблона по умолчанию`, `Список уроков`; выбор версии шаблона вынесен в общий Blade-компонент `x-pipeline-version-select`.
- В таблицу `projects` добавлены поля `default_pipeline_version_id` и `referer`; они сохранены в модели `Project` и используются при создании проекта из модала.
- Если у проекта задан `referer`, он автоматически передаётся в `yt-dlp` при скачивании аудио для любого урока этого проекта.
- Если в модале задан список уроков (формат `# Название` + следующая строка `https://...`), уроки автоматически добавляются в проект стандартным flow создания урока из YouTube с постановкой загрузки в очередь.
- При ошибке загрузки/нормализации аудио текст ошибки сохраняется не только в `lesson.settings.download_error`, но и в `error` первого шага queued-прогона; при этом статус шага остаётся `pending`.
- На странице списка строка проекта в таблице папки кликабельна и ведёт на страницу проекта; страница проекта (`projects.show`) показывает заголовок с именем проекта и сетку уроков в основном блоке шириной `2/3` (`2` колонки на `md+`).
- В карточке урока на странице проекта выводится список прогонов (`PipelineRun`): для `admin/superadmin` показывается подпись `Название • vN`, для пользователя с `access_level=0` — только `Название`; статусный badge остаётся одинаковым (`Готово`, `В очереди`, `Обработка`, `На паузе`).
- В карточке урока на странице проекта кнопка-оверлей удаления прогона показывается только для `admin/superadmin`; для пользователя с `access_level=0` она скрыта.
- В правом блоке страницы проекта добавлен dropdown `Сортировка уроков` с вариантами `Сортировка по дате добавления` и `Сортировка по названию`; выбранный вариант сохраняется в `project.settings.lessons_sort`.
- Для сортировки по названию на PostgreSQL используется ICU-коллация `numeric` (`und-u-kn-true`) для естественного порядка чисел в строках (`Lesson 2` перед `Lesson 10`).
- После нормализации аудио через `ffprobe` в `settings` урока сохраняется `audio_duration_seconds`; на карточке урока рядом с иконкой статуса загрузки выводится длительность в формате `Чч Мм` (или только `Мм`, если часов нет), минуты округляются из секунд.
- В карточке урока подпись длительности отображается без переноса строки (`nowrap`), чтобы значение не разбивалось на две строки.
- В `project.settings.lessons_audio_duration_seconds` хранится суммарная длительность уроков проекта; пересчёт выполняется отдельным action после нормализации аудио и при необходимости backfill-ит отсутствующие `audio_duration_seconds` у уроков проекта.
- Если `project.settings.lessons_audio_duration_seconds` рассчитана, в заголовке страницы проекта рядом с названием показывается подпись `Длительность Чч Мм` (или только `Мм`, если часов нет).
- При добавлении новой версии пайплайна в существующий урок результаты шагов автоматически переиспользуются до первого шага с отличающимся `step_version_id`; начиная с первого изменённого шага и далее создаются `pending`-шаги для нового пересчёта.
- Каждый прогон в списке урока кликабелен и ведёт на отдельную страницу прогона (`projects.runs.show`).
- Страница прогона (`projects.runs.show`) показывает breadcrumbs в цепочке `Проекты → Проект → Урок → Версия шаблона`, заголовок урока, подзаголовок версии и двухколоночный layout (`2/3 + 1/3`).
- В заголовке страницы прогона добавлены кнопки управления `Start / Pause / Stop`: `Start` показывается при наличии шагов `paused`, `Pause` — при наличии шагов `pending`, `Stop` — при наличии шагов `pending` или `running`; блок кнопок обновляется polling-ом `1s`.
- `Pause` завершает текущий `running` шаг и переводит следующие `pending` шаги в `paused`; `Stop` переводит текущий `running` и все `pending` шаги в `paused`; `Start` возвращает `paused` шаги в `pending` и возобновляет очередь.
- Правая колонка страницы прогона выводит интерактивный список шагов: клик выбирает активный шаг, а для каждого шага показываются статусный badge и метрики в стиле Tailwind UI `bages-small` (`i:{tokens}` и `o:{tokens}` — серые, `${price}` — amber).
- Для пользователей с `access_level=0` список шагов на странице прогона (desktop и mobile) упрощён: название отображается как `Шаг N. {Название}`, а метрики `i/o/$` скрыты; для `admin/superadmin` UI шага остаётся прежним.
- Для пользователей с `access_level=0` на странице прогона в заголовке и breadcrumbs скрывается суффикс версии пайплайна (`• vN`); для `admin/superadmin` отображение версии сохраняется.
- В мобильной версии страницы прогона список шагов отображается как dropdown между заголовком и блоком контента: в закрытом состоянии показывается текущий шаг с chevron, в открытом — полный список шагов с подсветкой текущего шага и переключением по клику.
- При открытии страницы прогона активным шагом по умолчанию выбирается последний шаг со статусом `done`; если готовых шагов нет, выбирается первый шаг списка.
- В верхней части левого блока страницы прогона добавлены кнопки действий (`Скачать PDF`, `Скачать MD`, `Скачать DOCX`, `Перезапуск шага`).
- Для кнопок `Скачать PDF`, `Скачать MD` и `Скачать DOCX` добавлена иконка скачивания слева от текста; кнопка `Перезапуск шага` приведена к тому же filled-стилю, что и `Скачать PDF`, но в amber-цвете.
- Кнопка `Перезапуск шага` на странице прогона подключена к Livewire-экшену и переиспользует сервисный `PipelineRunService::restartFromStep`: сбрасывает выбранный шаг и все последующие (`status/result/error/tokens/cost/time`) в `pending` и повторно ставит прогон в очередь `pipelines`.
- В левом блоке страницы прогона вместо текстовой заглушки добавлен выделенный контент-блок с фоном, который показывает `result` текущего выбранного шага.
- В блоке результата шага на странице прогона отображается только `Превью`: markdown рендерится в HTML через `league/commonmark` (`Str::markdown`) без переключения в режим исходника.
- Если выбранный шаг завершился с ошибкой (`failed`) и `result` пустой, в блоке результата вместо заглушки выводится текст ошибки красным.
- Исправлена стабильность сортировки шагов на странице прогона: порядок по `position` (и `id` как tie-breaker) сохраняется при выборе шага, без дополнительных повторных перечитываний данных в действиях компонента.
- Для страницы прогона реализовано скачивание результата выбранного шага в `PDF`, `Markdown` и `DOCX`: кнопки используют Livewire-экшены, проверки принадлежности шага прогону и готовности результата, PDF формируется через `PipelineStepPdfExporter`, а DOCX — через `PipelineStepDocxExporter` на базе `PHPWord`.
- Для каждого прогона добавлена hover-иконка удаления (появляется при наведении, прижата вправо и выровнена по центру строки); удаление подтверждается alert в стиле удаления урока.
- Удаление прогона со страницы проекта вынесено в отдельный `DeleteProjectPipelineRunAction`; после подтверждения прогон удаляется и уроки проекта перечитываются в Livewire-компоненте.
- На странице проекта блок действий рендерится один раз и адаптируется без дублирования: на `md+` он всегда виден как правая колонка, на мобильных открывается как выпадающее меню.
- Кнопка открытия/закрытия меню действий проекта находится справа от названия проекта и показывается только на мобильных (`md:hidden`).
- В мобильном режиме слой меню действий закреплён абсолютным блоком у верхнего края контейнера контента, закрывается по повторному нажатию на кнопку меню, по клику вне блока и по клику на любое действие внутри.
- В меню действий проекта доступны кнопки `Добавить урок`, `Добавить урок из аудио`, `Добавить список уроков`, `Редактировать проект`, `Пересчитать длительность` (запуск action пересчёта длительностей проекта), а также экспорт результатов в `PDF`, `MD` и `DOCX` (через общий modal выбора версии пайплайна и шага с последующей загрузкой ZIP-архива).
- Блок действий проекта разделён на 4 секции тонкими линиями: `настройки` (сортировка, редактирование, пересчёт длительности), `добавление уроков`, `скачивание`, `удаление`.
- В modal экспорта проекта доступен выбор именования файлов внутри ZIP (`Урок.{ext}` или `Урок - шаг.{ext}`), а имя скачиваемого ZIP формируется только из названия проекта.
- Для карточки урока на странице проекта добавлена иконка действия удаления: по клику открывается alert-подтверждение удаления конкретного урока с названием и предупреждением о необратимости.
- Удаление урока со страницы проекта вынесено в отдельный `DeleteProjectLessonAction`; после подтверждения урок удаляется и список уроков проекта перечитывается в Livewire-компоненте.
- По клику на название урока открывается модал редактирования (аналогично редактированию названия проекта); сохранение названия урока выполняется через отдельный `UpdateProjectLessonNameAction` с последующей перезагрузкой списка уроков проекта.
- Для кнопки `Добавить урок` добавлен модал (адаптация Tailwind UI `overlay/modal`) с полями `Название урока`, `Ссылка на YouTube` и выбором версии пайплайна через общий компонент `x-pipeline-version-select`; список версий формируется отдельным action в стиле `PipelineController::versions` и для `admin/superadmin` отображается как `Название • vN`.
- Во всех dropdown выбора версии пайплайна (создание/редактирование проекта, добавление урока по ссылке, из аудио и добавление пайплайна к уроку) у каждой опции добавлена вторая строка мелким шрифтом с `description` версии (или `Описание не задано.`).
- Для пользователей с `access_level=0` в этих dropdown скрывается суффикс номера версии (`• vN`); для `admin/superadmin` номер версии сохраняется.
- На странице проекта рядом с `Добавить урок` добавлена серая кнопка `Добавить урок из аудио`: отдельный модал принимает название, версию пайплайна и аудиофайл через drag&drop/выбор файла, после чего сервер валидирует формат, ставит нормализацию в очередь `downloads` и запускает pipeline после успешной нормализации.
- Во время загрузки файла в модале `Добавить урок из аудио` polling списка уроков приостанавливается по `livewire-upload-start` и возобновляется по `livewire-upload-finish/error/cancel`, чтобы избежать конфликтов фонового ререндера с upload-запросом.
- В модале `Добавить урок из аудио` добавлено toast-уведомление об ошибке загрузки файла с кнопкой `Обновить страницу`, которое показывается на `livewire-upload-error`.
- Создание урока из страницы проекта вынесено в отдельный `CreateProjectLessonFromYoutubeAction`: урок и `PipelineRun` (со статусом `queued`) создаются как в `LessonController::store`, запуск загрузки аудио выполняется как в `LessonController::download`.
- Согласован запуск очередей для нового урока: сначала ставится `DownloadLessonAudioJob` (очередь `downloads`), и только после успешной загрузки аудио автоматически диспатчится `ProcessPipelineJob` через `PipelineRunService::dispatchQueuedRuns`.
- Для кнопки `Изменить название` добавлен модал (адаптация Tailwind UI `overlay/modal`) с input названия (адаптация `forms/input`) и действиями `Сохранить` / `Отменить`; обновление имени выполняется через отдельный `UpdateProjectNameAction`.
- После сохранения нового названия на странице проекта модель перечитывается из БД (`$this->project->refresh()`), чтобы состояние компонента и заголовок страницы использовали актуальное имя.
- При клике на `Удалить проект` показывается alert-подтверждение (адаптация Tailwind UI `overlay/alert`) с кнопками `Удалить` и `Отменить`; фактическое удаление проекта выполняется отдельным `DeleteProjectAction`.
- В `ProjectShowPage` проект хранится как модель `Project` в состоянии Livewire-компонента; повторные `findOrFail` в рендере и действиях не используются.

## LLM и транскрибация

- Текстовые шаги выполняются через Laravel AI SDK (`config/ai.php`).
- Для транскрибации с провайдером `gemini` используется multimodal-подход: промт + audio attachment в текстовом запросе к Gemini.
- Если выбрана модель `whisper-*`, транскрибация идёт через штатный STT Laravel AI SDK.
- Кастомные прямые SDK-клиенты провайдеров в приложении не используются.

## Проверки качества

```bash
php artisan test
./vendor/bin/pint --test
```

При изменении фронтовых ассетов/шаблонов дополнительно:

```bash
pnpm build
```

## Документация

- Основные правила разработки: `AGENTS.md`
- Актуальные документы: `docs/`
- Архив старых документов: `docs/old/`

## История изменений

- Все изменения фиксируются в `CHANGELOG.md`.

## Лицензия

MIT
