# Video2Book

Серверное приложение для обработки лекций: проекты, уроки, версии пайплайнов, очереди прогонов и интеграции с LLM-провайдерами.

Текущая целевая архитектура: **Laravel + Livewire** (без desktop-клиента).

## Что делает приложение

- Управляет проектами и уроками.
- Хранит версионируемые пайплайны и шаги.
- Запускает обработку уроков через очередь `pipelines`.
- Поддерживает транскрибацию и текстовые шаги через OpenAI / Anthropic / Gemini.
- Считает usage и стоимость по каждому шагу.
- Экспортирует результаты шагов в PDF/Markdown.
- Поддерживает загрузку уроков по YouTube-ссылке через `yt-dlp`.

## Технологии

- PHP 8.4+
- Laravel 12
- Queue (database driver по умолчанию)
- Blade + Vite
- Livewire (целевая серверная UI-архитектура)
- Laravel AI SDK (`laravel/ai`) как единый слой для OpenAI / Anthropic / Gemini
- `protonemedia/laravel-ffmpeg` и `norkunas/youtube-dl-php`

## Быстрый старт

### 1. Установка

```bash
composer install
cp .env.example .env
php artisan key:generate
php artisan migrate
npm install
```

### 2. Обязательные `.env` переменные

Минимум:

- `OPENAI_API_KEY`
- `ANTHROPIC_API_KEY` (если используете Anthropic)
- `GEMINI_API_KEY` (если используете Gemini)

Полезные настройки:

- `LLM_REQUEST_TIMEOUT=1800`
- `LLM_ANTHROPIC_MAX_TOKENS=64000`
- `YTDLP_BINARY=yt-dlp`
- `QUEUE_CONNECTION=database`

### 3. Запуск разработки

В одном окне:

```bash
composer dev
```

Или отдельными процессами:

```bash
php artisan serve
php artisan queue:listen --tries=1 --queue=pipelines
npm run dev
```

## Архитектура репозитория

- `app/Http/Controllers` — API-контроллеры.
- `app/Jobs` — фоновые задания.
- `app/Models` — Eloquent-модели.
- `app/Services/Lesson` — загрузка/подготовка медиа.
- `app/Services/Pipeline` — запуск шагов, статусы, экспорт.
- `app/Services/Llm` — интеграция с Laravel AI SDK, usage/cost и лимиты.
- `routes/api.php` — REST API.
- `routes/web.php` — веб-маршруты для серверного UI.
- `resources/views` — Blade-шаблоны.
- `tests/Feature`, `tests/Unit` — покрытие API/сервисов.

## Доменные сущности

- `Project` — контейнер уроков.
- `Lesson` — единица обработки (источник + настройки).
- `Pipeline` / `PipelineVersion` — версия сценария обработки.
- `Step` / `StepVersion` — шаги версии пайплайна.
- `PipelineRun` / `PipelineRunStep` — фактический прогон и шаги выполнения.
- `ProjectTag` — теги проектов/уроков.

## API (основное)

- `GET/POST/PUT /api/projects`
- `POST /api/projects/youtube`
- `GET/POST/PUT /api/lessons`
- `POST /api/lessons/{lesson}/audio`
- `POST /api/lessons/{lesson}/download`
- `GET/POST/PUT /api/pipelines`
- `GET /api/pipeline-versions/{id}/steps`
- `GET/POST /api/pipeline-runs`
- `POST /api/pipeline-runs/{run}/restart`
- `GET /api/pipeline-runs/{run}/steps/{step}/export/pdf`
- `GET /api/pipeline-runs/{run}/steps/{step}/export/md`

## Livewire-переход

Архитектурное решение на этом этапе: развивать серверный UI на Livewire и использовать существующий доменный/сервисный слой без дублирования логики.

Рекомендованный подход:

1. Строить новые пользовательские сценарии как Livewire-компоненты.
2. Сложные операции оставлять в сервисах и очередях.
3. API сохранять как стабильный контракт для внутренних и внешних клиентов.

Текущий статус UI:
- Базовый серверный layout (`resources/views/layouts/app.blade.php`) уже подключён для web-страниц и содержит верхнюю навигацию, mobile-меню и контентный контейнер.
- В правой части layout используются кнопка настроек (`cog-8-tooth`, heroicons) и переключатель светлой/тёмной темы (адаптация Tailwind UI под Blade/Livewire), который применяет тему ко всей странице.
- Главная страница реализована как full-page Livewire-компонент (`app/Livewire/HomePage.php`) c данными из сервисного query-слоя (`app/Services/Project/RecentProjectsQuery.php`): левая колонка `2/3` показывает 5 последних изменённых проектов.
- Правая колонка `1/3` вынесена в отдельный Livewire-компонент (`app/Livewire/Widgets/DevelopmentQueueWidget.php`) и зарезервирована под виджет очереди разработки.
- Layout работает в режиме Livewire-only (рендер через `$slot`), без `@yield`-секций для Blade-страниц.
- Livewire views хранятся в `resources/views/pages/*` и `resources/views/widgets/*` (без каталога `resources/views/livewire`).
- Верхнее меню содержит разделы `Главная`, `Проекты`, `Пайплайны`; активный пункт определяется по имени роута (`routeIs`: `home`, `projects.*`, `pipelines.*`) и корректно подсвечивается на вложенных страницах.
- В layout между меню и контентом добавлены breadcrumbs (адаптация Tailwind UI): на главной breadcrumbs скрыты, на остальных страницах (`Проекты`, `Проект`, `Урок`, `Пайплайны`, `Шаг пайплайна`) путь формируется через параметры `breadcrumbs` в full-page Livewire-компонентах.
- Основной заголовок страницы (`h1`) рендерится внутри каждого page-шаблона (`resources/views/pages/*`), а не в общем layout.
- Основной layout не содержит встроенных `@php` блоков: конфигурация меню вынесена в `config/navigation.php`, а логика активного пункта и breadcrumbs описана через Blade-выражения.
- Основной текст в шаблонах использует базовый размер по умолчанию (без `text-sm`/`text-base`), уменьшение размера применяется только к второстепенным метаданным.
- Страница `Проекты` отображает все проекты в grid на 3 колонки, сортирует по `updated_at` по убыванию, показывает дату последнего изменения и количество уроков, а также использует пагинацию в стиле Tailwind UI.
- На странице `Проекты` в заголовке добавлена кнопка `+Добавить проект`, которая открывает модал создания проекта.
- Модал создания проекта содержит поля: `Название проекта` (обязательное), `Referer`, `Версия пайплайна по умолчанию`, `Список уроков`; список версий пайплайна использует тот же `el-select`-паттерн, что и в модале создания урока.
- В таблицу `projects` добавлены поля `default_pipeline_version_id` и `referer`; они сохранены в модели `Project` и используются при создании проекта из модала.
- Если в модале задан список уроков (формат `# Название` + следующая строка `https://...`), уроки автоматически добавляются в проект стандартным flow создания урока из YouTube с постановкой загрузки в очередь.
- Карточки проектов на странице списка кликабельны и ведут на страницу проекта; страница проекта (`projects.show`) показывает заголовок с именем проекта и сетку уроков в основном блоке шириной `2/3` (`2` колонки на `md+`).
- В карточке урока на странице проекта выводится список прогонов (`PipelineRun`): для каждого прогона отображаются название и версия пайплайна (`Название • vN`) и статусный badge в стиле Tailwind UI (`Готово`, `В очереди`, `Обработка`, `На паузе`).
- Каждый прогон в списке урока кликабелен и ведёт на отдельную страницу прогона (`projects.runs.show`).
- Страница прогона (`projects.runs.show`) показывает breadcrumbs в цепочке `Проекты → Проект → Урок → Версия пайплайна`, заголовок урока, подзаголовок версии и двухколоночный layout (`2/3 + 1/3`).
- В заголовке страницы прогона добавлены кнопки управления `Start / Pause / Stop`: `Start` показывается при наличии шагов `paused`, `Pause` — при наличии шагов `pending`, `Stop` — при наличии шагов `pending` или `running`; блок кнопок обновляется polling-ом `1s`.
- `Pause` завершает текущий `running` шаг и переводит следующие `pending` шаги в `paused`; `Stop` переводит текущий `running` и все `pending` шаги в `paused`; `Start` возвращает `paused` шаги в `pending` и возобновляет очередь.
- Правая колонка страницы прогона выводит интерактивный список шагов: клик выбирает активный шаг, а для каждого шага показываются статусный badge и метрики в стиле Tailwind UI `bages-small` (`i:{tokens}` и `o:{tokens}` — серые, `${price}` — amber).
- При открытии страницы прогона активным шагом по умолчанию выбирается последний шаг со статусом `done`; если готовых шагов нет, выбирается первый шаг списка.
- В верхней части левого блока страницы прогона добавлены кнопки действий (`Скачать PDF`, `Скачать MD`, `Перезапуск шага`).
- Для кнопок `Скачать PDF` и `Скачать MD` добавлена иконка скачивания слева от текста; кнопка `Перезапуск шага` приведена к тому же filled-стилю, что и `Скачать PDF`, но в amber-цвете.
- Кнопка `Перезапуск шага` на странице прогона подключена к Livewire-экшену и переиспользует сервисный `PipelineRunService::restartFromStep`: сбрасывает выбранный шаг и все последующие (`status/result/error/tokens/cost/time`) в `pending` и повторно ставит прогон в очередь `pipelines`.
- В левом блоке страницы прогона вместо текстовой заглушки добавлен выделенный контент-блок с фоном, который показывает `result` текущего выбранного шага.
- В блоке результата шага добавлен переключатель `Превью / Исходник`: в режиме `Превью` markdown рендерится в HTML через `league/commonmark` (`Str::markdown`), в режиме `Исходник` показывается сырой markdown-текст.
- Исправлена стабильность сортировки шагов на странице прогона: порядок по `position` (и `id` как tie-breaker) сохраняется при выборе шага, без дополнительных повторных перечитываний данных в действиях компонента.
- Для страницы прогона реализовано скачивание результата выбранного шага в `PDF` и `Markdown`: кнопки используют Livewire-экшены, проверки принадлежности шага прогону и готовности результата, а PDF формируется через существующий `PipelineStepPdfExporter`.
- Для каждого прогона добавлена hover-иконка удаления (появляется при наведении, прижата вправо и выровнена по центру строки); удаление подтверждается alert в стиле удаления урока.
- Удаление прогона со страницы проекта вынесено в отдельный `DeleteProjectPipelineRunAction`; после подтверждения прогон удаляется и уроки проекта перечитываются в Livewire-компоненте.
- На странице проекта добавлен правый блок действий без фоновой плашки: кнопки `Добавить урок` (indigo), `Изменить название` (gray), `Удалить проект` (red).
- Для карточки урока на странице проекта добавлена иконка действия удаления: по клику открывается alert-подтверждение удаления конкретного урока с названием и предупреждением о необратимости.
- Удаление урока со страницы проекта вынесено в отдельный `DeleteProjectLessonAction`; после подтверждения урок удаляется и список уроков проекта перечитывается в Livewire-компоненте.
- По клику на название урока открывается модал редактирования (аналогично редактированию названия проекта); сохранение названия урока выполняется через отдельный `UpdateProjectLessonNameAction` с последующей перезагрузкой списка уроков проекта.
- Для кнопки `Добавить урок` добавлен модал (адаптация Tailwind UI `overlay/modal`) с полями `Название урока`, `Ссылка на YouTube` и выбором версии пайплайна через шаблонный `forms/select` (`el-select` из `@tailwindplus/elements`); список версий формируется отдельным action в стиле `PipelineController::versions` и отображается как `Название • vN`.
- Создание урока из страницы проекта вынесено в отдельный `CreateProjectLessonFromYoutubeAction`: урок и `PipelineRun` (со статусом `queued`) создаются как в `LessonController::store`, запуск загрузки аудио выполняется как в `LessonController::download`.
- Согласован запуск очередей для нового урока: сначала ставится `DownloadLessonAudioJob` (очередь `downloads`), и только после успешной загрузки аудио автоматически диспатчится `ProcessPipelineJob` через `PipelineRunService::dispatchQueuedRuns`.
- Для кнопки `Изменить название` добавлен модал (адаптация Tailwind UI `overlay/modal`) с input названия (адаптация `forms/input`) и действиями `Сохранить` / `Отменить`; обновление имени выполняется через отдельный `UpdateProjectNameAction`.
- После сохранения нового названия на странице проекта модель перечитывается из БД (`$this->project->refresh()`), чтобы состояние компонента и заголовок страницы использовали актуальное имя.
- При клике на `Удалить проект` показывается alert-подтверждение (адаптация Tailwind UI `overlay/alert`) с кнопками `Удалить` и `Отменить`; фактическое удаление проекта выполняется отдельным `DeleteProjectAction`.
- В `ProjectShowPage` проект хранится как модель `Project` в состоянии Livewire-компонента; повторные `findOrFail` в рендере и действиях не используются.

## LLM и транскрибация

- Текстовые шаги выполняются через Laravel AI SDK (`config/ai.php`).
- Для транскрибации с провайдером `gemini` используется multimodal-подход: промт + audio attachment в текстовом запросе к Gemini.
- Если выбрана модель `whisper-*`, транскрибация идёт через штатный STT Laravel AI SDK.
- Кастомные прямые SDK-клиенты провайдеров в приложении не используются.

## Проверки качества

```bash
php artisan test
./vendor/bin/pint --test
```

При изменении фронтовых ассетов/шаблонов дополнительно:

```bash
npm run build
```

## Документация

- Основные правила разработки: `AGENTS.md`
- Актуальные документы: `docs/`
- Архив старых документов: `docs/old/`

## История изменений

- Все изменения фиксируются в `CHANGELOG.md`.

## Лицензия

MIT
