# Переезд на серверную работу 

## Проекты 
+ Добавление проекта 

## Проект 
+ Добавление пайплайна в урок 
+ При добавлении новой версии пайплайна в урок новый прогон переиспользует результаты неизменённых шагов до первого несовпадения `step_version_id`; начиная с первого изменённого шага выполняется новый расчёт
+ Скачивание всего проекта (PDF / MD / DOCX)
+ Проектная версия пайплайна 
+ Обновление статуса прогонов 
+ Статус загрузки урока
+ Расчёт длительности аудио после нормализации через `ffprobe` с сохранением в `lesson.settings.audio_duration_seconds` и отображением `HH:MM` на карточке урока
+ Добавление урока загрузкой аудиофайла (drag&drop / выбор файла) с последующей нормализацией в MP3 в очереди `downloads`
+ Для модала загрузки аудио polling списка уроков приостанавливается на время `livewire`-upload (`start`) и возобновляется после `finish/error/cancel`
+ Для ошибки `livewire`-загрузки в модале добавлено toast-уведомление с рекомендацией обновить страницу
+ При ошибке download/normalize аудио сообщение сохраняется в `pipeline_run_steps.error` первого шага queued-прогона урока, при этом статус шага остаётся `pending`
+ На странице проекта добавлен выбор сортировки уроков (`по дате добавления` / `по названию`) с сохранением в `project.settings.lessons_sort`
+ В карточке урока на странице проекта в списке прогонов для пользователя `access_level=0` отображается только название пайплайна (без `vN`), для `admin/superadmin` отображение `Название • vN` сохранено
+ Во время открытого dropdown сортировки polling списка уроков временно приостанавливается, чтобы popover не закрывался из-за фонового ререндера
+ Для сортировки уроков по названию в PostgreSQL используется ICU-коллация `numeric` (`und-u-kn-true`), что даёт natural sorting для числовых суффиксов в названиях
+ Dropdown выбора версии пайплайна в модалках проекта/уроков вынесен в общий Blade-компонент `x-pipeline-version-select`
+ В списке опций dropdown выбора версии пайплайна добавлена вторая строка с `description` версии (fallback: `Описание не задано.`)
+ Для пользователя `access_level=0` в этом dropdown скрывается номер версии `• vN` (админы видят номер версии как раньше)

## Прогон 
+ Перезапуск с текущего шага
+ Start, Stop, ExtremeStop 
+ Обновление статусов шагов и прогона в целом
+ Обновление результатов по мере обработки
+ При открытии прогона текущий шаг выбирается так: `is_default` (если `done`) → последний `done` → `is_default` → первый шаг
+ Если ни у одного шага нет `settings.is_default`, по умолчанию используется последний шаг
+ Экспорт выбранного шага в PDF / MD / DOCX
+ PDF-экспорт переведён на `barryvdh/laravel-dompdf` (генерация из HTML/CSS)
+ Шаблон PDF вынесен в Blade: `resources/views/pdf/pipeline-step.blade.php` (`Pdf::loadView`)
+ Исправлен runtime-конфликт Alpine (`isActionsMenuOpen`) на странице прогона при переходах через `wire:navigate` и фоновых polling-запросах
+ Для пользователя с `access_level=0` список шагов (desktop/mobile) показывается в упрощённом виде: `Шаг N. {Название}` и только badge статуса (без метрик токенов/стоимости)
+ Для пользователя с `access_level=0` на странице прогона в заголовке и breadcrumbs отображается только название пайплайна (без `• vN`); для `admin/superadmin` формат `Название • vN` сохранён
+ Для выбранного шага со статусом `failed` и пустым `result` в основном блоке результата выводится текст ошибки красным (в режимах `Превью` и `Исходник`) вместо заглушки об отсутствии результата

## Pipeline 
+ Список 
+ Добавить пайплайн
+ Редактировать название и описание 
+ Переключить на версию 
+ Добавить шаг
+ Редактировать шаг
+ Удалить шаг 
+ Архивировать версию
+ Для шагов типа `text` на странице пайплайна доступен checkbox шага по умолчанию (только один на версию), флаг хранится в `step_versions.settings.is_default`
+ При создании нового пайплайна флаг `is_default` автоматически ставится на первый шаг типа `text`

## Пользователи
+ Страница `Пользователи` (только `admin/superadmin`)
+ Кнопка `Добавить пользователя`
+ Карточки пользователей с удалением через confirm-модал
+ Модалы добавления/редактирования: имя, email, переключатель уровня доступа (`пользователь` / `админ`) двумя кнопками
+ Модал редактирования: invite-ссылка, копирование invite-ссылки, кнопка `Новый токен`
+ Карточка superadmin видна только самому superadmin

## Очередь 
+ Виджет задач 
+ Механизм обновления 

## Downloader
+ В `config/downloader.php` добавлена опциональная настройка прокси `proxy` (`YT_PROXY` в `.env`)
+ Если `YT_PROXY` задан, сервис скачивания добавляет `--proxy` в параметры `yt-dlp`; по умолчанию прокси не используется

## Доступ в web-layer
+ Упрощённая token-auth по `users.access_token` (несколько пользователей)
+ Invite endpoint `/invite/{token}`: выставляет постоянный cookie и редиректит на главную
+ Проверка cookie-токена выполняется отдельным middleware; при ошибке показывается страница `Доступ закрыт`
+ `AuthenticateTeamAccessToken` подключён к `web` middleware group, поэтому проверка токена работает и для `livewire.update` запросов
+ `team@local` используется как изначальный superadmin (`access_level=2`)
+ Консольные команды для Forge:
  + `auth:generate-invite` — создаёт/обновляет superadmin `team@local` и ротирует токен
  + `auth:show-invite` — показывает текущий invite superadmin без ротации
+ Уровни доступа:
  + `0` — пользователь (`Главная`, `Проекты`)
  + `1` — админ (дополнительно `Пайплайны`, `Пользователи`)
  + `2` — суперадмин
