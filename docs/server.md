# Переезд на серверную работу 

## Проекты 
+ Добавлены папки проектов (`folders`) и связь `projects.folder_id`
+ Миграция создаёт первую папку `Проекты` и переносит в неё существующие проекты
+ На странице `Проекты` список построен как аккордеон `папка -> проекты` (открыта только одна папка)
+ В заголовке страницы кнопка `Добавить папку` открывает модал с полем `Название папки`
+ Для строки открытой папки доступны действия `Изменить` и `Добавить проект` (для закрытых папок действия скрыты)
+ Модал создания проекта переиспользован, но открывается в контексте папки с заголовком `Добавить проект в «{папка}»`
+ Проекты в открытой папке отображаются таблицей (`table-stacked-on-mobile`) с колонками `перетаскивание`, `название`, `уроки`, `длительность`
+ На mobile (до `md`) `уроки` и `длительность` стакаются в формат `Уроков: N` и `Длительность: N`
+ Строка проекта кликабельна и ведёт на страницу проекта
+ Проект можно перетащить за handle из открытой папки на любую закрытую папку; после drop обновляется `projects.folder_id`, а папка назначения автоматически раскрывается
+ Добавление проекта в выбранную папку

## Проект 
+ Добавление шаблона в урок 
+ При добавлении новой версии шаблона в урок новый прогон переиспользует результаты неизменённых шагов до первого несовпадения `step_version_id`; начиная с первого изменённого шага выполняется новый расчёт
+ Скачивание всего проекта (PDF / MD / DOCX)
+ Проектная версия пайплайна 
+ Обновление статуса прогонов 
+ Статус загрузки урока
+ Расчёт длительности аудио после нормализации через `ffprobe` с сохранением в `lesson.settings.audio_duration_seconds` и отображением на карточке урока в формате `Чч Мм` (или только `Мм`, если часов нет); минуты округляются из секунд
+ Подпись длительности в карточке урока фиксируется без переноса строки (`nowrap`)
+ Суммарная длительность уроков сохраняется в `project.settings.lessons_audio_duration_seconds`; после нормализации запускается action пересчёта, который также backfill-ит отсутствующие длительности в `lesson.settings.audio_duration_seconds`
+ В меню действий проекта после кнопки `Редактировать проект` добавлена серая кнопка `Пересчитать длительность`, которая вручную запускает action пересчёта; во время выполнения на кнопке показывается крутилка слева от текста
+ Если суммарная длительность проекта рассчитана, в заголовке страницы проекта рядом с названием отображается подпись `Длительность Чч Мм` (или только `Мм`, если часов нет)
+ Блок действий проекта разбит на 4 секции с тонкими разделителями: `сортировка/редактирование/пересчёт`, `добавление уроков`, `скачивание`, `удаление`
+ Добавление урока загрузкой аудиофайла (drag&drop / выбор файла) с последующей нормализацией в MP3 в очереди `downloads`
+ Для модала загрузки аудио polling списка уроков приостанавливается на время `livewire`-upload (`start`) и возобновляется после `finish/error/cancel`
+ Для ошибки `livewire`-загрузки в модале добавлено toast-уведомление с рекомендацией обновить страницу
+ При ошибке download/normalize аудио сообщение сохраняется в `pipeline_run_steps.error` первого шага queued-прогона урока, при этом статус шага остаётся `pending`
+ На странице проекта добавлен выбор сортировки уроков (`по дате добавления` / `по названию`) с сохранением в `project.settings.lessons_sort`
+ В карточке урока на странице проекта в списке прогонов для пользователя `access_level=0` отображается только название пайплайна (без `vN`), для `admin/superadmin` отображение `Название • vN` сохранено
+ В карточке урока кнопка-оверлей удаления прогона доступна только для `admin/superadmin`; для `access_level=0` скрыта
+ Во время открытого dropdown сортировки polling списка уроков временно приостанавливается, чтобы popover не закрывался из-за фонового ререндера
+ Для сортировки уроков по названию в PostgreSQL используется ICU-коллация `numeric` (`und-u-kn-true`), что даёт natural sorting для числовых суффиксов в названиях
+ Dropdown выбора версии шаблона в модалках проекта/уроков вынесен в общий Blade-компонент `x-pipeline-version-select`
+ В списке опций dropdown выбора версии шаблона добавлена вторая строка с `description` версии (fallback: `Описание не задано.`)
+ Для пользователя `access_level=0` в этом dropdown скрывается номер версии `• vN` (админы видят номер версии как раньше)

## Прогон 
+ Перезапуск с текущего шага
+ Start, Stop, ExtremeStop 
+ Обновление статусов шагов и прогона в целом
+ Обновление результатов по мере обработки
+ При открытии прогона текущий шаг выбирается так: `is_default` (если `done`) → последний `done` → `is_default` → первый шаг
+ Если ни у одного шага нет `settings.is_default`, по умолчанию используется последний шаг
+ Экспорт выбранного шага в PDF / MD / DOCX
+ PDF-экспорт переведён на `barryvdh/laravel-dompdf` (генерация из HTML/CSS)
+ Шаблон PDF вынесен в Blade: `resources/views/pdf/pipeline-step.blade.php` (`Pdf::loadView`)
+ Исправлен runtime-конфликт Alpine (`isActionsMenuOpen`) на странице прогона при переходах через `wire:navigate` и фоновых polling-запросах
+ Для пользователя с `access_level=0` список шагов (desktop/mobile) показывается в упрощённом виде: `Шаг N. {Название}` и только badge статуса (без метрик токенов/стоимости)
+ Для пользователя с `access_level=0` на странице прогона в заголовке и breadcrumbs отображается только название шаблона (без `• vN`); для `admin/superadmin` формат `Название • vN` сохранён
+ В основном блоке результата на странице прогона оставлен только режим `Превью` (без переключения в `Исходник`)
+ Для выбранного шага со статусом `failed` и пустым `result` в основном блоке результата выводится текст ошибки красным вместо заглушки об отсутствии результата

## Pipeline 
+ Список 
+ Добавить шаблон
+ Редактировать название и описание 
+ Переключить на версию 
+ Добавить шаг
+ Редактировать шаг
+ Удалить шаг 
+ Архивировать версию
+ Для шагов типа `text` на странице пайплайна доступен checkbox шага по умолчанию (только один на версию), флаг хранится в `step_versions.settings.is_default`
+ При создании нового пайплайна флаг `is_default` автоматически ставится на первый шаг типа `text`

## Пользователи
+ Страница `Пользователи` (только `admin/superadmin`)
+ Кнопка `Добавить пользователя`
+ Карточки пользователей с удалением через confirm-модал
+ Модалы добавления/редактирования: имя, email, переключатель уровня доступа (`пользователь` / `админ`) двумя кнопками
+ Модал редактирования: invite-ссылка, копирование invite-ссылки, кнопка `Новый токен`
+ При ротации токена текущим авторизованным пользователем новый токен сразу пробрасывается в auth-cookie, чтобы не терялся доступ
+ Карточка superadmin видна только самому superadmin

## Активность
+ Страница `Активность` доступна для `admin/superadmin`.
+ Каждая запись отображается одной строкой: `d.m.Y H:i — пользователь — добавил(а)/изменил(а)/удалил(а) — проект/урок/прогон — название объекта`.
+ История берётся из `activity_log` и выводится с пагинацией по `20` записей на страницу.
+ Для типа `прогон` название собирается из урока, названия шаблона и версии: `Урок — Шаблон • vN`.
+ Для типа `урок` в названии добавляется проект: `Урок в проекте «Проект»`.
+ Системные события без автора (`causer`) в журнал не попадают.

## Логи действий
+ Подключён `spatie/laravel-activitylog` и создана таблица `activity_log`.
+ Для `Project` логируются события `created`, `updated`, `deleted`.
+ Для `Lesson` логируются события `created`, `updated`, `deleted`.
+ Для `PipelineRun` логируются события `created`, `deleted`.
+ В каждой записи фиксируются `causer_type/causer_id` (кто сделал) и `subject_type/subject_id` (над каким объектом).
+ Логирование выполняется только при наличии авторизованного пользователя (`App\Models\User`) как автора действия.

## Удаление сущностей
+ Для `User`, `Project`, `Lesson` и `PipelineRun` используется soft delete (`deleted_at`).
+ Каскадное удаление не применяется: при удалении проекта связанные уроки и прогоны остаются в БД.
+ На уровне пользовательских сценариев это безопасно за счёт иерархической навигации (без доступа к вложенным сущностям удалённого родителя).

## Очередь 
+ Виджет задач 
+ Механизм обновления 

## Downloader
+ В `config/downloader.php` добавлена опциональная настройка прокси `proxy` (`YT_PROXY` в `.env`)
+ Если `YT_PROXY` задан, сервис скачивания добавляет `--proxy` в параметры `yt-dlp`; по умолчанию прокси не используется

## Доступ в web-layer
+ Упрощённая token-auth по `users.access_token` (несколько пользователей)
+ Invite endpoint `/invite/{token}`: выставляет постоянный cookie и редиректит на главную
+ Проверка cookie-токена выполняется отдельным middleware; при ошибке показывается страница `Доступ закрыт`
+ `AuthenticateTeamAccessToken` подключён к `web` middleware group, поэтому проверка токена работает и для `livewire.update` запросов
+ `team@local` используется как изначальный superadmin (`access_level=2`)
+ Консольные команды для Forge:
  + `auth:generate-invite` — создаёт/обновляет superadmin `team@local` и ротирует токен
  + `auth:show-invite` — показывает текущий invite superadmin без ротации
+ Уровни доступа:
  + `0` — пользователь (`Главная`, `Проекты`)
  + `1` — админ (дополнительно `Шаблоны`, `Пользователи`, `Активность`)
  + `2` — суперадмин
