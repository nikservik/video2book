# Управление пайплайнами

Для перехода к управлению пайплайнами нужно на главной странице добавить в шапке иконку «Пайплайн» справа от иконки настроек.

Код для иконок бери в файле `icons.md`.

Для пайплайнов у нас будет несколько вью, поэтому их нужно вынести в отдельную папку `views/Pipelines`.
Для пайплайнов понадобится свой store, который будет взаимодействовать с api через отдельный сервис.

## [x] Layout
Для всех страниц работы с пайплайнами нам нужен стандартизированный лейаут.

### Шапка
Шапка должна быть fixed. Слева и справа в шапке обязательный padding, чтобы кнопки управления окном в electron не перекрывали элементы управления.

Шапку организуем по принципу breadcrumbs.
- Слева иконка «Пайплайн»
- Дальше название пайплайна
- Если выбран шаг, то он идет следующим элементом
- Для разделителя есть отдельная иконка

В правой части шапки место для иконок управления и статусов.

При работе с пайплайнами в шапке с правой стороны есть только компонент для переключения темы темная/светлая и иконка «Домой».
Иконка «Домой» переключает на список проектов.

Переключение тем нужно вынести в компонент, чтобы код не дублировался на каждой странице.

### Контент окна
Остальная часть окна остается под контент. У нее есть padding со всех сторон. И вертикальный скролл, если нужно.


## [x] View: Список пайплайнов

Это стартовая страница для работы с пайплайнами.

В шапке: иконка «Пайплайн» > Пайплайны

### Список пайплайнов
Загружаем один раз из api при переходе к пайплайнам. Пока подразумеваем, что никто не будет редактировать пайплайны параллельно.

Список нужно оформить так же, как сейчас показан список проектов на главной:
- Название пайплайна
- После названия в этой же строке более мелко указываем номер версии так: вер. 12
- Одна строка из описания с автоматическим тримом с троеточием
- Иконок никаких нет
- При клике на пайплан переходим на отображение пайплайна. Важно передавать пайплайн и версию.

Пагинацию списка  не нужно делать, это пока не актуально.

Над списком справа кнопка «+ Добавить пайплайн»

## [x] View: Добавление пайплайна
При добавлении пайплайна мы указываем только названия шагов. Это удобно и позволяет избежать создании кучи версий пайплайна, если бы каждый шаг добавляли вручную.

Шапка: иконка «Пайплайн» > Добавления пайплайна

Поля в форме:
- Название (строка)
- Описание (4 строки с автопереносом, скролл только вертикальный)
- Динамический список шагов
    - название
    - любой шаг можно удалить (справа иконка «Удалить»)
    - любой шаг можно перетащить, ухватить можно за любую часть шага
    - Последний псевдо-шаг – это кнопка «+ Добавить шаг», ее нельзя перетащить

При сохранении важно передать порядок шагов.

Внизу кнопки, как на странице создния проекта:
- Отменить (слева)
- Сохранить (справа)
    - на кнопке перед «Сохранить» должна быть скрытая крутилка загрузки
    - во время взаимодействия с api крутилка становится видимой
    - лучше крутилку сделать компонентом, чтобы переиспользовать код

После сохранения переход на страницу

На сервере при сохранении:
- первому шагу присваиваем тип `transcribe`
- каждому шагу устанавливать в input_step_id предыдущий шаг (не версию)
- каждому шагу status=draft

### [x] Обновление БД и модели step_version
- для поля status добавить вариант значения 'draft'
- добавить поле input_step_id, которое указывает на id из steps
- добавить метод для получения текущей версии input_step

## [x] View: Пайплайн
По умолчанию берет текущую версию пайплайна. Но может отображать любую заданную версию.

В шапке: иконка «Пайплайн» > Название пайплайна

Пока функционал выбора версий не будем реализовывать. При загруз

Важно возвращаться к конкретной версии пайплайна из вложенных страниц.

Отображение:
- Название
- Описание
- Превью changelog на 4 строки с кнопкой «Подробнее» для открытия на отдельной странице
- Шаги
    - Название шага-источника (мелко, с иконкой «Источник» перед названием)
    - Название (перед названием иконка с типом шага)
        - Если у шага status=draft, то начинаем с желтой иконки «Предупреждение»
    - Короткое описание
    - В одну строку
        - Модель
        - Температура
    - Промт (превью 5 строк)

Справа от названия пайплайна  кнопка с иконкой редактирования (float right) - переключает на страницу редактирования пайплайна.

Справа от названия каждого шага кнопка с иконкой редактирования (float right) - переключает на страницу редактирования шага.

Между шагами есть линия разделитель с иконкой «Добавить» (плюс в кружке) посредине. «Добавить» переключает на страницу добавления шага. Такая же линия есть в начале и в конце списка шагов. Так мы можем добавить шаг в любое место списка. Важно передать позицию, чтобы при сохранении шага мы правильно ее указали в pipeline_version_step и сдвинули остальные шаги.

### [x] Перетаскивание шагов
Слева от названия каждого шага есть иконка для перетаскивания. Она с отрицательным margin «торчит» влево от списка. Шаг можно перетаскивать только за эту иконку. При наведении на иконку курсор меняется на руку.

После перетаскивания шага нужно отправить запрос api на смену порядка шагов. На время обработки запроса все иконки перетаскивания теряют возможность перетаскивания. Слева от иконки перетаскивания у перемещенного шага появляется крутилка загрузки.

После успешного сохранения новой позиции шага получаем от api новую версию пайплайна и переключаемся на нее.

Если сохранение не удалось, то перемещенный шаг нужно вернуть на старое место. И сообщить об ошибке.

### [x] Реализовать в api сохранение нового порядка
- делаем новую версию пайплайна из той, которая отображается
- в changelog добавляем запись: - Шаг ... перемещен с позиции ... на позицию ...
- для новой версии сохраняем новый порядок шагов
- возвращаем новый номер версии

## [x] View: Редактирование пайплайна
В шапке: иконка «Пайплайн» > Название пайплайна (жирным, помельче) \n Редактирование (покрупнее, но не жирным)

То есть, в шапке мы из названия делаем 2 строки:
- само название немного уменьшаем
- второй строкой пишем «Редактирование»

Поля для редактирования в основном окне:
- Название
    - Строка
- Описание
    - 4 строки с автопереносом, скролл только вертикальный

Внизу кнопки:

- Отмена (слева)
- Сохранить (справа, серая как «отмена»)
- Сохранить \n новая версия (индиго)

В кнопке «Сохранить \n новая версия» слово «Сохранить» написано как в остальных кнопках, а «новая версия» второй строчкой мелко.

После сохранения переключаемся на версию, которую вернет api.

### [x] Реализовать на сервере
Кроме стантартного сохраннения с автоматическим созданием новой версии, нужно добавить возможность сохранять изменения в текущую версию. Здесь мы правим только название и описание, может быть это будет просто изменение орфографии.

В любом варианте сохранения нужно возвращать версию пайплайна, на которую нужно переключить отображение.

## [x] View: Редактирование шага
В шапке:
- иконка «Пайплайн»
- Название пайплайна
- Название шага

Для длинных названий нужно предусмотреть их обрезанное отображение с ...

Форма редактирования:
- Шаг-источник (слева иконка «Источник»)
    - Выпадающий список шагов
    - Исключаем себя и шаги с типом glossary
- Название
    - Строка
- Короткое описание
    - 2 строки с автопереносом
- Модель
    - Выпадающий список
    - Сгруппированы по провайдерам
    - Провайдер выбирается автоматом при выборе модели, пользователь его не видит
- Температура
    - Ползунок от 0 до 1 с шагом 0.1
- Тип шага
    - Выпадающий список
    - транскрибация/обработка/словарь = transcribe|text|glossary
- Промт
    - Большое текстовое поле на 25 строк
- Описание изменения
    - 2 строки

Внизу кнопки:

- Отмена (слева)
- Сохранить (справа, по стилю как «отмена»)
- Сохранить \n новая версия (зеленая)

Поле с описанием изменения обязательно для сохранения новой версии. Для старой оно не используется.

После сохранения в новую версию будет сохранена не только новая версия шага, но и создана новая версия пайплайна. Нам нужно из редактирования шага вернуться к просмотру новой версии пайплайна.

### [x] Реализовать на сервере
Кроме стантартного сохраннения с автоматическим созданием новой версии, нужно добавить возможность сохранять изменения в текущую версию. На случай исправления мелких ошибок.

В любом варианте сохранения нужно возвращать версию пайплайна, на которую нужно переключить отображение.
