# Переезд на серверную обработку

Нам нужно вынести хранение и обработку проектов на серверную часть. На фронте остается только нормализация аудио.

Я уже поставил Laravel 12 в папку server. Настроил БД postgres. Локально он доступен по адресу http://api.video2book.test/
Это чистая установка, там ничего нет, кроме настроек БД и url в .env.

Сначала нам нужно занятся реализацией серверной части. Сделаем, протестируем, после этого переключим обработку с фронта на бэк.

## 1. Множественные пайплайны с версионностью
Пайпланов теперь будет несколько. Каждый пайплайн состоит из нескольких шагов.

Версионность есть и у пайплана, и у каждого отдельного шага. Каждая версия иммунна. То есть, при обновлении мы не меняем существующую версию, а создаем новую и записываем ее в current_version.

Проанализируй структуру данных и создай модели и миграции.

Проанализируй раздел Действия и создай соответствующие эндпоинты api, реализуй их обработку.

Напиши тесты и проверь их выполнение. Тесты пиши на phpunit, размещай их в server/tests.

### Структура данных
pipeline
- id
- current_version_id

pipline_version
- id
- pipline_id
- version (int)
- title (string)
- description (text)
- changelog (text)
- created_by (user_id)
- status [active|archived]

step
- id
- current_version_id

step_version
- id
- step_id
- name (string)
- type [transcribe|text|glossary]
- version (int)
- description (text)
- prompt (text)
- settings (json)
- status [active|disabled|draft]

pipeline_version_step
- id
- pipeline_version_id
- step_version_id
- position (int)

### Действия
1) Создание пайплайна
- на вход получаем все данные самого пайплана (как в pipline_version) и названия всех шагов
- сохраняем данные в первую версию и создаем все шаги, но без версий (имя шага появится только вместе с `step_version`)

2) Заполнение шага в новом пайплайне
- на вход получаем все данные шага (как в step_version)
- сохраняем в первую версию и обновляем step.current_version_id
- версию пайплайна не обновляем

3) Добавление нового шага в существующий пайплайн
- на вход получаем все данные шага (как в step_version)
- создаем новый шаг и добавляем его первую версию
- создаем новую версию пайплайна с добавлением в changelog нового шага
- в pipeline_version_step сохраняем последовательность шагов для новой версии пайплайна с новым шагом

4) Изменение шага
- на вход получаем все данные шага (как в step_version) + описание изменения для changelog
- сохраняем новую версию шага и обновляем step.current_version_id
- создаем новую версию пайплайна с добавлением в changelog описания изменения этого шага
- в pipeline_version_step сохраняем последовательность шагов для новой версии пайплайна с новой версией шага

5) Удаление шага
- на вход получаем id шага
- создаем новую версию пайплайна с добавлением в changelog удаления шага
- в pipeline_version_step сохраняем последовательность шагов для новой версии пайплайна без шага
- ни шаг, ни его версии из базы не удаляем

6) Изменение пайплайна
- на вход получаем title и description
- создаем новую версию пайплайна с добавлением в changelog записи об обновлении названия и описания
- в pipeline_version_step сохраняем последовательность шагов для новой версии пайплайна

7) Архивация пайплайна
- на вход получаем id
- в текущей версии меняем status на archived
- в changelog ничего не меняем

8) Список пайплайнов
- возвращает текущие версии всех пайплайнов (status=active)

9) Список версий пайплайна
- на вход id пайплайна
- возвращает все версии пайплайна

10) Список шагов версии пайплайна
- на вход id версии пайплайна
- возвращает текущие версии всех шагов версии пайплайна

11) Список версий шага
- на вход id шага
- возвращает список версий шага

## 2. Проекты
Структура данных о проекте остается прежней. Убираем только рабочую папку, потому что она неактуальна на сервере.

Добавляем теги, чтобы удобнее было сортировать проекты.
Теги можно добавлять/изменять/удалять. Удалять можно только если нет проектов с таким тегом.

В project_step будем позже сохранять результаты выполнения шага. Пока ничего с ним не делаем.

Проанализируй структуру данных и создай модели и миграции.

Проанализируй раздел Действия и создай соответствующие эндпоинты api, реализуй их обработку.

Напиши тесты и проверь их выполнение. Тесты пиши на phpunit, размещай их в server/tests.

### Структура данных
project
- id
- name (string)
- tag (string) = project_tag.slug
- source_filename (string)
- pipeline_version_id
- settings (json)

project_step
- id
- project_id
- step_version_id
- start_time
- end_time
- error (text)
- result (text)
- input_tokens (int)
- output_tokens (int)
- cost (decimal)

project_tag
- id
- slug (string)
- description (text)

### Действия
1) Добавить проект
- на входе все данные как в project кроме source_filename
- сохраняем проект

2) Загрузить нормализованное аудио
- на входе id проекта и аудио-файл
- файл сохраняем в storage/projects/{id}.mp3
- сохраняем в проект source_filename

3) Изменить проект
- на входе все данные как в project кроме source_filename
- сохраняем изменения

4) Список проектов
- на входе опционально тег и/или строка для поиска
- возвращаем список подходящих проектов

## Выполнено (2025-12-24)

- [x] Реализованы миграции/модели/эндпоинты для версионируемых пайплайнов и шагов, включая полный набор действий (создание, заполнение шага, добавление/изменение/удаление шага, обновление/архивация пайплайна) + тесты `server/tests/Feature/PipelineApiTest.php`.
- [x] Созданы данные/REST для проектов и тегов: CRUD тегов с проверкой использования, создание/редактирование проектов, загрузка нормализованного аудио в `storage/projects/{id}.mp3`, поиск/фильтрация проектов. Покрыто тестами `server/tests/Feature/ProjectApiTest.php`.
- [x] Все PHP‑тесты проходят (`cd server && php artisan test`).

## Сервисы для запросов к LLM

Я установил пакеты с LLM-клиентами:
- https://github.com/openai-php/laravel
- https://github.com/mozex/anthropic-laravel
- https://github.com/google-gemini-php/laravel

## 3. Прогоны пайплайна

Структуру проектов нужно дополнить прогонами (PipelineRun).

Раньше у нас с каждым проектом была связана единственная версия пайплайна, по которой он обрабатывался. Сейчас нам нужно добавить возможность обрабатывать один проект несколькими версиями пайплайна. Поэтому появляется понятие PipelineRun. А ProjectStep преобразуется в PipelineRunStep.

PipelineRun связан с одной версией пайплайна, по которой и выполняется обработка проекта.

При добавлении миграций не нужно заботиться о данных в старой структуре – их еще нет.

### Обновленнная структура

project
- id
- name (string)
- tag (string) = project_tag.slug
- source_filename (string)
- settings (json)

pipeline_run
- id
- project_id
- pipeline_version_id
- state (json)
- status [queued|running|failed|done]

pipline_run_step
- id
- pipeline_run_id
- step_version_id
- position (int)
- start_time
- end_time
- error (text)
- result (text)
- input_tokens (int)
- output_tokens (int)
- cost (decimal)
- status [pending|running|failed|done]
