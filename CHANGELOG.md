# Changelog

All notable changes to this project are documented here.

The format is inspired by Keep a Changelog. Versions aim to follow SemVer.

## [Unreleased]

### Planned
- Server UI rollout on Livewire for project/lesson/pipeline workflows.
- Coverage expansion for Livewire-driven user scenarios.

### Changed
- Транскрибация через `gemini` переведена на multimodal-flow (audio attachment + prompt в текстовом запросе), а для `whisper-*` сохранён стандартный STT путь Laravel AI SDK.
- Добавлен основной Blade-лейаут `resources/views/layouts/app.blade.php` по шаблону dashboard-навигации (desktop + mobile), `welcome` переведён на этот layout.
- Локальная иконка приложения подключена как favicon (`public/favicon.png`, без преобразования исходного `resources/images/favicon.png`) и как логотип в основном layout.
- В правой части layout удалены bell/avatar, добавлена иконка `cog-8-tooth` (heroicons path) и переключатель светлой/тёмной темы (адаптация шаблона Tailwind UI из Vue под Blade/Livewire), который применяет тему ко всей странице.
- Раздел `Dashboard` переименован в `Главная`; на странице добавлен список 5 последних изменённых проектов (левая колонка `2/3`) и зарезервирована правая колонка `1/3` под будущий виджет очереди разработки.
- Архитектура главной переведена на Livewire: выборка вынесена из `routes/web.php` в `RecentProjectsQuery`, страница реализована full-page компонентом `HomePage`, а правый блок — отдельным компонентом `DevelopmentQueueWidget`.
- Удалена поддержка Blade `@yield` в основном layout (Livewire-only рендер через `$slot`); views компонентов перенесены из `resources/views/livewire/*` в `resources/views/pages/*` и `resources/views/widgets/*`.
- Реализовано интерактивное меню (`Главная`, `Проекты`, `Пайплайны`) на `wire:navigate` с active-state по именам роутов (`home`, `projects.*`, `pipelines.*`), включая вложенные страницы (`projects.lessons.show`, `pipelines.steps.show`).
- В шаблонах убраны `text-sm`/`text-base` для основного текста; уменьшенные размеры оставлены только для второстепенных элементов (`text-xs`).
- Страница `Проекты` переведена на реальный список: grid `3` колонки, сортировка по последнему изменению (`updated_at desc`), отображение даты изменения и количества уроков, плюс нижняя пагинация в стиле Tailwind UI.
- Карточки проектов на странице списка сделаны кликабельными (`projects.show`); добавлена страница просмотра проекта с заголовком-именем проекта и списком уроков в основном блоке шириной `2/3`.
- В layout добавлены breadcrumbs между меню и заголовком (адаптация Tailwind UI): на главной они скрыты, на остальных full-page Livewire-страницах путь формируется через `breadcrumbs` в `layout(...)`.
- Выполнен рефакторинг основного layout: удалены все `@php`-блоки из Blade, навигационные пункты вынесены в `config/navigation.php`.
- На странице просмотра проекта добавлен правый блок действий без фоновой подложки с тремя UI-кнопками: `Добавить урок` (indigo), `Изменить название` (gray), `Удалить проект` (red).
- Для кнопки `Изменить название` добавлен модал в стиле Tailwind UI (`overlay/modal`) с полем ввода (`forms/input`) и действиями `Сохранить` / `Отменить`; обновление названия вынесено в отдельный `UpdateProjectNameAction`.
- После сохранения нового названия проекта в модале модель перечитывается из БД, чтобы заголовок и breadcrumbs сразу отображали актуальное имя.
- Для кнопки `Удалить проект` добавлен alert-подтверждение в стиле Tailwind UI (`overlay/alert`) с кнопками `Удалить` и `Отменить`; удаление выполнено через отдельный `DeleteProjectAction`.
- Исправлен рендер страницы проекта при открытии alert удаления: модальное окно встроено в единый корневой контейнер Livewire, добавлены стабильные `wire:key` для строк уроков и повторная загрузка проекта в `render()` для консистентного порядка.
- `ProjectShowPage` отрефакторен обратно на хранение модели `Project` в состоянии Livewire (без повторных `findOrFail` на каждом рендере/действии).
- Заголовок страницы (`h1`) вынесен из `resources/views/layouts/app.blade.php` в page-шаблоны `resources/views/pages/*`; в layout оставлены только breadcrumbs.
- На странице проекта реализован сценарий добавления урока: по кнопке `Добавить урок` открывается модал с полями названия, YouTube-ссылки и выбора версии пайплайна через `forms/select` (`el-select`), а подписи версий приведены к формату `Название • vN`.
- Создание урока и запуск связанного pipeline вынесены в `CreateProjectLessonFromYoutubeAction` (без переиспользования контроллера): сначала создаются `Lesson` + `PipelineRun` (`dispatchJob: false`), затем ставится `DownloadLessonAudioJob`.
- Гарантирована последовательность обработки для нового урока: `ProcessPipelineJob` не диспатчится при создании, а запускается автоматически только после успешной загрузки аудио в `DownloadLessonAudioJob` через `PipelineRunService::dispatchQueuedRuns`.
- Блок уроков на странице проекта переведён в grid из двух колонок; в каждой карточке урока выводится список прогонов (`PipelineRun`) с названием/версией пайплайна и статусным badge (`Готово`, `В очереди`, `Обработка`) в стиле Tailwind UI.
- Для перехода из списка прогонов добавлен web-маршрут и страница просмотра прогона `projects.runs.show` (`ProjectRunPage`) с корректными breadcrumbs и активным разделом меню `Проекты`.
- На карточке урока добавлено действие удаления через иконку: по клику открывается alert-подтверждение с заголовком `Удалить урок {название}` и предупреждением о необратимости удаления вместе с расшифровками.
- Удаление урока реализовано отдельным `DeleteProjectLessonAction`; после подтверждения урок удаляется и список уроков проекта перечитывается.
- На странице проекта добавлено редактирование названия урока по клику на его название: открывается модал в стиле редактирования проекта, после сохранения список уроков перечитывается.
- Сохранение нового названия урока вынесено в отдельный `UpdateProjectLessonNameAction`; добавлены unit/feature-тесты для модала и обновления имени урока.
- В списке прогонов урока добавлена иконка удаления, которая показывается только при наведении на прогон (в правой части строки, по вертикальному центру).
- Для удаления прогона добавлен alert-подтверждение в стиле удаления урока; подтверждение удаляет выбранный прогон и перечитывает уроки проекта.
- Удаление прогона реализовано отдельным `DeleteProjectPipelineRunAction`; добавлены unit/feature-тесты на открытие alert и успешное удаление прогона.
- Страница `projects.runs.show` переведена на новый UI: breadcrumbs `Проекты → Проект → Урок → Версия`, заголовок урока и подзаголовок версии пайплайна, двухколоночный layout с контентом шага слева и списком шагов справа.
- В списке шагов прогона реализован выбор активного шага по клику, статусные badge (`Готово`, `В очереди`, `Обработка`) и метрики шага в формате `i:{tokens}`, `o:{tokens}`, `${price}` через шаблон `bages-small` (amber, форматирование чисел).
- Для метрик шага на странице прогона обновлены цвета badge: `i:{tokens}` и `o:{tokens}` сделаны серыми, `${price}` оставлен в amber.
- В левом блоке страницы прогона добавлен верхний ряд из трёх кнопок действий: `Скачать PDF` (indigo), `Скачать MD` (gray), `Перезапуск шага` (amber), пока без подключённых действий.
- Для кнопок скачивания на странице прогона добавлена иконка слева от текста; кнопка `Перезапуск шага` переведена на тот же стиль, что `Скачать PDF`, с amber-цветовой схемой.
- В основном (левом) блоке страницы прогона заглушка заменена на выделенный фоновой контент-блок, который выводит результат (`result`) текущего выбранного шага.
- В блок результата шага добавлен переключатель `Превью / Исходник`: превью рендерит markdown в HTML через `league/commonmark`, исходник показывает сырой markdown.
- Для страницы прогона изменён выбор шага по умолчанию: при загрузке активируется последний завершённый (`done`) шаг, а при отсутствии завершённых — первый шаг списка.
- Исправлен скачок порядка шагов после выбора шага на странице прогона: relation `PipelineRun::steps()` теперь всегда отдает шаги в `position -> id`, добавлен регрессионный feature-тест.
- На странице прогона подключено скачивание результата выбранного шага в PDF/Markdown: для PDF используется существующий `PipelineStepPdfExporter`, для обоих форматов добавлены имена файлов по шаблону `lesson-step` и feature-тесты Livewire download-ответов.
- На странице списка проектов добавлена кнопка `+Добавить проект` в заголовке и модал создания проекта с полями `Название`, `Referer`, `Версия пайплайна по умолчанию`, `Список уроков`.
- Добавлены поля `projects.default_pipeline_version_id` и `projects.referer` (миграция + модель `Project`).
- Реализован `CreateProjectFromLessonsListAction`: создаёт проект и, при заполненном списке уроков в формате `# Название` + `https://...`, добавляет уроки стандартным flow через `CreateProjectLessonFromYoutubeAction`.
- Добавлены feature-тесты `ProjectsPageTest` для нового flow: открытие/закрытие модала, создание проекта с обязательным полем `Название`, пакетное добавление уроков и валидация версии пайплайна при заполненном списке уроков.
- В модале добавления урока на странице проекта выбор версии пайплайна по умолчанию теперь учитывает `projects.default_pipeline_version_id` (с fallback на первую доступную версию); добавлен feature-тест.
- На странице проекта модал редактирования расширен до `Редактировать проект`: добавлены поля `Referrer` и `Версия пайплайна по умолчанию` с предвыбором текущего значения проекта и сохранением через `UpdateProjectNameAction`.
- На карточках уроков добавлено действие `добавить версию пайплайна`: новая иконка `+`, модал выбора версии с фильтрацией уже добавленных версий урока и предвыбором дефолтной версии проекта; создание прогона вынесено в `AddPipelineVersionToLessonAction`.
- На странице проекта добавлено скачивание результатов проекта в `PDF`/`MD`: кнопки в сайдбаре, модал выбора pipeline/шага (аккордеон), фильтрация по `done` прогонам и только `text` шагам, сборка результатов всех уроков в ZIP через новые `Action`-классы.
- На странице проекта добавлен polling списка уроков (`wire:poll.2s`) для актуализации статусов прогонов, которые меняются в фоне воркерами.
- На странице проекта рядом с названием урока добавлена иконка статуса загрузки аудио: `failed` (red), `queued` (gray), `running` (yellow), `loaded` (green, при наличии `source_filename` независимо от прошлых ошибок).
- Для страницы прогона добавлено управление `Start/Pause/Stop` через отдельные action-классы: `Pause` переводит будущие шаги в `paused`, `Stop` переводит `running+pending` в `paused`, `Start` возвращает `paused` в `pending` и возобновляет очередь; блок кнопок в заголовке обновляется polling-ом `1s`.
- На странице прогона реализован `Перезапуск шага`: кнопка перезапускает выбранный шаг и все последующие через отдельный `RestartPipelineRunFromStepAction` (переиспользование `PipelineRunService::restartFromStep`), сбрасывает их результаты и повторно ставит прогон в очередь.
- Исправлена миграция `2026_02_14_120000_add_paused_statuses_to_pipeline_run_statuses` для PostgreSQL: вместо проблемного `enum()->change()` обновление выполняется через пересоздание `CHECK`-ограничений статусов.
- На правый блок со списком шагов страницы прогона добавлен условный polling `2s` (`wire:poll.2s="refreshRunSteps"`): он включается только если есть незавершённые шаги (`status != done`).
- На блок результата выбранного шага страницы прогона добавлен polling `1s` (`wire:poll.1s="refreshSelectedStepResult"`), но только когда выбранный шаг имеет статус `running`.

## [2026-02-11] refactor: migrate LLM layer to Laravel AI SDK

- `app/Services/Llm` переписан на единый Laravel AI SDK: убраны кастомные провайдерные клиенты OpenAI/Anthropic/Gemini и их wiring в контейнере.
- `DefaultPipelineStepExecutor` переведён на `Laravel\\Ai\\Transcription` для STT и на новый `LlmManager` для текстовых шагов.
- Удалены зависимости `mozex/anthropic-laravel`, `openai-php/laravel`, `google-gemini-php/laravel`; `composer.lock` обновлён, Laravel обновлён до `12.51.0`.
- Обновлены unit-тесты LLM-слоя под новый gateway-based контракт и пересобран package manifest.
- Документация (`README.md`, `AGENTS.md`) синхронизирована с новой архитектурой LLM-интеграции.

## [2026-02-09] docs: Laravel + Livewire documentation baseline

- Полностью обновлены `AGENTS.md` и `README.md` под архитектуру Laravel + Livewire.
- Удалены legacy-упоминания desktop-слоя и старого монорепо-расположения.
- Исправлены ссылки на документацию: актуальные материалы живут в `docs/`, архив — в `docs/old/`.
- Обновлена структура changelog под standalone Laravel-репозиторий.

## [2026-01-07] feat: multi-lesson youtube projects

- Добавлен сервис `LessonDownloadManager` и эндпоинт `POST /api/projects/youtube`, который создаёт проект, уроки, стартовые `PipelineRun` и ставит загрузки в очередь.
- Логика резолва тегов вынесена в `LessonTagResolver`.
- Feature-тесты расширены под массовый сценарий создания уроков по ссылкам.

## [2026-01-06] feat: youtube lesson downloads

- Добавлен `POST /api/lessons/{lesson}/download` и джоба `DownloadLessonAudioJob`.
- Сервер скачивает аудио через `yt-dlp`, нормализует в MP3 и запускает pipeline processing.
- Добавлены события очереди загрузки (`download-started/progress/completed/failed`) для наблюдаемости.
- Добавлены feature-тесты `LessonDownloadTest`.

## [2026-01-03] fix: queue dispatch after audio upload

- Создание урока больше не запускает обработку до фактической загрузки аудио.
- `PipelineRunService::dispatchQueuedRuns()` используется после получения MP3.
- Исключены преждевременные старты прогонов без входного файла.
- Конфиги LLM обновлены: общий таймаут и лимит токенов Anthropic вынесены в `.env`.

## [2025-12-29] feat: pipeline runs and step statuses

- Добавлены сущности `PipelineRun` и `PipelineRunStep` со статусами выполнения.
- Реализованы эндпоинты очереди и перезапуска прогона с выбранного шага.
- `ProcessPipelineJob` обрабатывает шаги последовательно и устойчиво к retry-сценариям.
- Feature-тесты покрывают новый контур прогонов.

## [2025-12-24] feat: pipeline versioning and LLM abstraction

- Реализована версияция пайплайнов и шагов (`pipelines`, `pipeline_versions`, `steps`, `step_versions`, `pipeline_version_steps`).
- Добавлены API-контроллеры для управления пайплайнами, версиями и шагами.
- Внедрён слой `app/Services/Llm` с провайдерами OpenAI, Anthropic и Gemini.
- Добавлен расчёт стоимости в `LlmCostCalculator` на основе `config/pricing.php`.
- Unit и feature-тесты покрывают базовую доменную модель и LLM-провайдеры.
