# Changelog

All notable changes to this project are documented here.

The format is inspired by Keep a Changelog. Versions aim to follow SemVer.

## [Unreleased]

### Planned
- Server UI rollout on Livewire for project/lesson/pipeline workflows.
- Coverage expansion for Livewire-driven user scenarios.

### Changed
- Экспорт PDF результата шага переведён с `TCPDF` на `barryvdh/laravel-dompdf`: обновлён `PipelineStepPdfExporter`, удалён пакет `elibyy/tcpdf-laravel`, добавлен unit-тест генерации PDF.
- HTML-разметка PDF-экспорта вынесена из `PipelineStepPdfExporter` в Blade-шаблон `resources/views/pdf/pipeline-step.blade.php`; генерация переведена на `Pdf::loadView(...)`.
- Транскрибация через `gemini` переведена на multimodal-flow (audio attachment + prompt в текстовом запросе), а для `whisper-*` сохранён стандартный STT путь Laravel AI SDK.
- Добавлен основной Blade-лейаут `resources/views/layouts/app.blade.php` по шаблону dashboard-навигации (desktop + mobile), `welcome` переведён на этот layout.
- Локальная иконка приложения подключена как favicon (`public/favicon.png`, без преобразования исходного `resources/images/favicon.png`) и как логотип в основном layout.
- В правой части layout удалены bell/avatar, добавлена иконка `cog-8-tooth` (heroicons path) и переключатель светлой/тёмной темы (адаптация шаблона Tailwind UI из Vue под Blade/Livewire), который применяет тему ко всей странице.
- Раздел `Dashboard` переименован в `Главная`; на странице добавлен список 5 последних изменённых проектов (левая колонка `2/3`) и зарезервирована правая колонка `1/3` под будущий виджет очереди разработки.
- Архитектура главной переведена на Livewire: выборка вынесена из `routes/web.php` в `RecentProjectsQuery`, страница реализована full-page компонентом `HomePage`, а правый блок — отдельным компонентом `QueueWidget`.
- Удалена поддержка Blade `@yield` в основном layout (Livewire-only рендер через `$slot`); views компонентов перенесены из `resources/views/livewire/*` в `resources/views/pages/*` и `resources/views/widgets/*`.
- Реализовано интерактивное меню (`Главная`, `Проекты`, `Пайплайны`) на `wire:navigate` с active-state по именам роутов (`home`, `projects.*`, `pipelines.*`), включая вложенные страницы (`projects.lessons.show`, `pipelines.steps.show`).
- В шаблонах убраны `text-sm`/`text-base` для основного текста; уменьшенные размеры оставлены только для второстепенных элементов (`text-xs`).
- Страница `Проекты` переведена на реальный список: grid `3` колонки, сортировка по последнему изменению (`updated_at desc`), отображение даты изменения и количества уроков, плюс нижняя пагинация в стиле Tailwind UI.
- Карточки проектов на странице списка сделаны кликабельными (`projects.show`); добавлена страница просмотра проекта с заголовком-именем проекта и списком уроков в основном блоке шириной `2/3`.
- В layout добавлены breadcrumbs между меню и заголовком (адаптация Tailwind UI): на главной они скрыты, на остальных full-page Livewire-страницах путь формируется через `breadcrumbs` в `layout(...)`.
- Выполнен рефакторинг основного layout: удалены все `@php`-блоки из Blade, навигационные пункты вынесены в `config/navigation.php`.
- На странице просмотра проекта добавлен правый блок действий без фоновой подложки с тремя UI-кнопками: `Добавить урок` (indigo), `Изменить название` (gray), `Удалить проект` (red).
- Для кнопки `Изменить название` добавлен модал в стиле Tailwind UI (`overlay/modal`) с полем ввода (`forms/input`) и действиями `Сохранить` / `Отменить`; обновление названия вынесено в отдельный `UpdateProjectNameAction`.
- После сохранения нового названия проекта в модале модель перечитывается из БД, чтобы заголовок и breadcrumbs сразу отображали актуальное имя.
- Для кнопки `Удалить проект` добавлен alert-подтверждение в стиле Tailwind UI (`overlay/alert`) с кнопками `Удалить` и `Отменить`; удаление выполнено через отдельный `DeleteProjectAction`.
- Исправлен рендер страницы проекта при открытии alert удаления: модальное окно встроено в единый корневой контейнер Livewire, добавлены стабильные `wire:key` для строк уроков и повторная загрузка проекта в `render()` для консистентного порядка.
- `ProjectShowPage` отрефакторен обратно на хранение модели `Project` в состоянии Livewire (без повторных `findOrFail` на каждом рендере/действии).
- Заголовок страницы (`h1`) вынесен из `resources/views/layouts/app.blade.php` в page-шаблоны `resources/views/pages/*`; в layout оставлены только breadcrumbs.
- На странице проекта реализован сценарий добавления урока: по кнопке `Добавить урок` открывается модал с полями названия, YouTube-ссылки и выбора версии пайплайна через `forms/select` (`el-select`), а подписи версий приведены к формату `Название • vN`.
- Создание урока и запуск связанного pipeline вынесены в `CreateProjectLessonFromYoutubeAction` (без переиспользования контроллера): сначала создаются `Lesson` + `PipelineRun` (`dispatchJob: false`), затем ставится `DownloadLessonAudioJob`.
- Гарантирована последовательность обработки для нового урока: `ProcessPipelineJob` не диспатчится при создании, а запускается автоматически только после успешной загрузки аудио в `DownloadLessonAudioJob` через `PipelineRunService::dispatchQueuedRuns`.
- Блок уроков на странице проекта переведён в grid из двух колонок; в каждой карточке урока выводится список прогонов (`PipelineRun`) с названием/версией пайплайна и статусным badge (`Готово`, `В очереди`, `Обработка`) в стиле Tailwind UI.
- Для перехода из списка прогонов добавлен web-маршрут и страница просмотра прогона `projects.runs.show` (`ProjectRunPage`) с корректными breadcrumbs и активным разделом меню `Проекты`.
- На карточке урока добавлено действие удаления через иконку: по клику открывается alert-подтверждение с заголовком `Удалить урок {название}` и предупреждением о необратимости удаления вместе с расшифровками.
- Удаление урока реализовано отдельным `DeleteProjectLessonAction`; после подтверждения урок удаляется и список уроков проекта перечитывается.
- На странице проекта добавлено редактирование названия урока по клику на его название: открывается модал в стиле редактирования проекта, после сохранения список уроков перечитывается.
- Сохранение нового названия урока вынесено в отдельный `UpdateProjectLessonNameAction`; добавлены unit/feature-тесты для модала и обновления имени урока.
- В списке прогонов урока добавлена иконка удаления, которая показывается только при наведении на прогон (в правой части строки, по вертикальному центру).
- Для удаления прогона добавлен alert-подтверждение в стиле удаления урока; подтверждение удаляет выбранный прогон и перечитывает уроки проекта.
- Удаление прогона реализовано отдельным `DeleteProjectPipelineRunAction`; добавлены unit/feature-тесты на открытие alert и успешное удаление прогона.
- Страница `projects.runs.show` переведена на новый UI: breadcrumbs `Проекты → Проект → Урок → Версия`, заголовок урока и подзаголовок версии пайплайна, двухколоночный layout с контентом шага слева и списком шагов справа.
- В списке шагов прогона реализован выбор активного шага по клику, статусные badge (`Готово`, `В очереди`, `Обработка`) и метрики шага в формате `i:{tokens}`, `o:{tokens}`, `${price}` через шаблон `bages-small` (amber, форматирование чисел).
- Для метрик шага на странице прогона обновлены цвета badge: `i:{tokens}` и `o:{tokens}` сделаны серыми, `${price}` оставлен в amber.
- В левом блоке страницы прогона добавлен верхний ряд из трёх кнопок действий: `Скачать PDF` (indigo), `Скачать MD` (gray), `Перезапуск шага` (amber), пока без подключённых действий.
- Для кнопок скачивания на странице прогона добавлена иконка слева от текста; кнопка `Перезапуск шага` переведена на тот же стиль, что `Скачать PDF`, с amber-цветовой схемой.
- В основном (левом) блоке страницы прогона заглушка заменена на выделенный фоновой контент-блок, который выводит результат (`result`) текущего выбранного шага.
- В блок результата шага добавлен переключатель `Превью / Исходник`: превью рендерит markdown в HTML через `league/commonmark`, исходник показывает сырой markdown.
- Для страницы прогона изменён выбор шага по умолчанию: при загрузке активируется последний завершённый (`done`) шаг, а при отсутствии завершённых — первый шаг списка.
- Исправлен скачок порядка шагов после выбора шага на странице прогона: relation `PipelineRun::steps()` теперь всегда отдает шаги в `position -> id`, добавлен регрессионный feature-тест.
- На странице прогона подключено скачивание результата выбранного шага в PDF/Markdown: для PDF используется существующий `PipelineStepPdfExporter`, для обоих форматов добавлены имена файлов по шаблону `lesson-step` и feature-тесты Livewire download-ответов.
- На странице списка проектов добавлена кнопка `+Добавить проект` в заголовке и модал создания проекта с полями `Название`, `Referer`, `Версия пайплайна по умолчанию`, `Список уроков`.
- Добавлены поля `projects.default_pipeline_version_id` и `projects.referer` (миграция + модель `Project`).
- Реализован `CreateProjectFromLessonsListAction`: создаёт проект и, при заполненном списке уроков в формате `# Название` + `https://...`, добавляет уроки стандартным flow через `CreateProjectLessonFromYoutubeAction`.
- Добавлены feature-тесты `ProjectsPageTest` для нового flow: открытие/закрытие модала, создание проекта с обязательным полем `Название`, пакетное добавление уроков и валидация версии пайплайна при заполненном списке уроков.
- В модале добавления урока на странице проекта выбор версии пайплайна по умолчанию теперь учитывает `projects.default_pipeline_version_id` (с fallback на первую доступную версию); добавлен feature-тест.
- На странице проекта модал редактирования расширен до `Редактировать проект`: добавлены поля `Referrer` и `Версия пайплайна по умолчанию` с предвыбором текущего значения проекта и сохранением через `UpdateProjectNameAction`.
- На карточках уроков добавлено действие `добавить версию пайплайна`: новая иконка `+`, модал выбора версии с фильтрацией уже добавленных версий урока и предвыбором дефолтной версии проекта; создание прогона вынесено в `AddPipelineVersionToLessonAction`.
- На странице проекта добавлено скачивание результатов проекта в `PDF`/`MD`/`DOCX`: кнопки в сайдбаре, модал выбора pipeline/шага (аккордеон), фильтрация по `done` прогонам и только `text` шагам, сборка результатов всех уроков в ZIP через новые `Action`-классы.
- На странице проекта добавлен polling списка уроков (`wire:poll.2s`) для актуализации статусов прогонов, которые меняются в фоне воркерами.
- На странице проекта рядом с названием урока добавлена иконка статуса загрузки аудио: `failed` (red), `queued` (gray), `running` (yellow), `loaded` (green, при наличии `source_filename` независимо от прошлых ошибок).
- Для страницы прогона добавлено управление `Start/Pause/Stop` через отдельные action-классы: `Pause` переводит будущие шаги в `paused`, `Stop` переводит `running+pending` в `paused`, `Start` возвращает `paused` в `pending` и возобновляет очередь; блок кнопок в заголовке обновляется polling-ом `1s`.
- На странице прогона реализован `Перезапуск шага`: кнопка перезапускает выбранный шаг и все последующие через отдельный `RestartPipelineRunFromStepAction` (переиспользование `PipelineRunService::restartFromStep`), сбрасывает их результаты и повторно ставит прогон в очередь.
- Исправлена миграция `2026_02_14_120000_add_paused_statuses_to_pipeline_run_statuses` для PostgreSQL: вместо проблемного `enum()->change()` обновление выполняется через пересоздание `CHECK`-ограничений статусов.
- На правый блок со списком шагов страницы прогона добавлен условный polling `2s` (`wire:poll.2s="refreshRunSteps"`): он включается только если есть незавершённые шаги (`status != done`).
- На блок результата выбранного шага страницы прогона добавлен polling `1s` (`wire:poll.1s="refreshSelectedStepResult"`), но только когда выбранный шаг имеет статус `running`.
- На главной странице список последних проектов сделан кликабельным: каждый элемент ведёт на `projects.show` с `wire:navigate`.
- Реализован виджет очереди обработки на главной странице: данные берутся из таблицы `jobs`, есть polling `2s`, для `ProcessPipelineJob` показываются урок/версия пайплайна/шаги со статусами, для `DownloadLessonAudioJob` — урок/версия пайплайна/прогресс скачивания.
- В виджете очереди обработки названия шагов переведены на `text-sm`, а статусы шагов отображаются маленькими badge в стиле `twui` (`elements/bages-small`).
- Элементы задач в виджете очереди обработки сделаны сворачиваемыми (`details/summary`): по умолчанию показываются иконка, урок и версия пайплайна, по клику раскрываются детали (шаги со статусами или прогресс скачивания).
- В заголовок элемента задачи очереди добавлен правый счётчик прогресса шагов прогона в формате `done/total`.
- В виджете очереди обработки цвет иконки задачи теперь зависит от состояния job: `indigo` для выполняемой (`jobs.reserved_at != null`) и `gray` для ожидающей.
- Убрано слово `Development` из имен файлов и классов рабочего виджета очереди: компонент переименован в `QueueWidget`, шаблон в `queue-widget.blade.php`, провайдер в `QueueWidgetDataProvider`.
- В виджете очереди раскрытие/сворачивание задач переведено на явный `wire:click`: состояние аккордеона больше не сбрасывается polling-обновлением и меняется только по клику.
- Страница `Пайплайны` реализована по паттерну списка проектов: grid из карточек с названием, номером текущей версии и `description`, плюс кнопка `Добавить пайплайн` в заголовке.
- Добавлено создание пайплайна через модал на странице списка: поля `Название`/`Описание` и динамический drag-and-drop список шагов с предзаполнением `Транскрибация` + `Структура`.
- Команда `auth:generate-invite` сделана устойчивой для запуска в Forge: если `team@local` отсутствует, пользователь создаётся автоматически, а invite-ссылка всегда печатается в stdout.
- Добавлена команда `auth:show-invite` для Forge: печатает текущую invite-ссылку без ротации токена (и создаёт токен только если он ещё отсутствует).
- В downloader добавлена опциональная настройка `YT_PROXY`: при наличии значения сервис скачивания передаёт прокси в параметры `yt-dlp`, по умолчанию прокси не используется.
- Добавлены регрессионные unit-тесты `LessonDownloadService` на очистку временных файлов и директорий после нормализации в обоих сценариях: загрузка из YouTube и загрузка пользовательского аудиофайла (включая ветки с ошибкой).
- Очистка временных данных после нормализации уточнена: удаляется только конкретный временный аудиофайл (без удаления родительских директорий), чтобы исключить риски для параллельных воркеров.
- Создание нового пайплайна вынесено в `CreatePipelineWithStepsAction`: первый шаг создаётся как `transcribe`, остальные как `text`, все новые версии шагов получают `status=draft`, а `input_step_id` строится цепочкой на предыдущий шаг; после сохранения выполняется redirect на `pipelines.show`.
- Для нового пайплайна стартовая версия (`v1`) теперь создаётся в статусе `archived` по умолчанию, пока её шаги находятся в `draft`.
- Удалены устаревшие `CreatePipelinePage` и маршрут `pipelines.create`, так как создание перенесено в modal flow на `pipelines.index`.
- Исправлены перескакивания и дубли названий шагов при drag-and-drop в модале создания пайплайна.
- Логика редактирования списка шагов в модале создания пайплайна перенесена целиком на Alpine (`x-sort` + локальное состояние), а в Livewire при сохранении передаётся итоговый массив названий шагов в фактическом DOM-порядке после перетаскивания.
- Добавлена страница просмотра пайплайна (`pipelines.show`) с шагами выбранной версии: по умолчанию активна текущая версия пайплайна, справа размещены кнопки действий и список версий с выбором активной версии.
- В карточках шагов на странице пайплайна показываются источник (`input_step`), тип шага (icon), имя шага, версия шага, модель (violet badge), описание и иконка удаления в правом верхнем углу.
- В правом блоке страницы пайплайна кнопки обновлены: `Редактировать версию` (indigo) и `Архивировать версию` (красная), кнопка удаления пайплайна убрана.
- Кнопка `Архивировать версию` на странице пайплайна приведена к стандартному filled red-стилю из шаблонов Tailwind UI (`twui`).
- На странице пайплайна подключено переключение статуса выбранной версии: `active -> archived` (кнопка `Архивировать версию`) и `archived -> active` (кнопка `Вернуть из архива`) через отдельный `Action`.
- В списке версий архивные версии помечаются серым цветом.
- В правый блок страницы пайплайна добавлена кнопка `Сделать текущей версией`: для текущей версии она неактивна, для остальных назначает выбранную версию как `current_version_id` пайплайна через отдельный `Action`.
- Кнопка `Сделать текущей версией` на странице пайплайна теперь также недоступна для архивированных версий; добавлена серверная защита от назначения `archived` версии текущей.
- Кнопка `Вернуть из архива` на странице пайплайна блокируется, если в выбранной версии есть шаги со статусом `draft`; добавлена серверная защита от такого восстановления.
- В списке версий на странице пайплайна для архивированных версий добавлена отдельная иконка архива справа.
- В списке пайплайнов для архивированной текущей версии название отображается серым (без зачёркивания), а вместо номера версии справа показывается иконка архива.
- Выбор версий пайплайна в UI (проект/урок и связанные формы) переведён на `current`-версии со статусом `active`; архивные и не-текущие версии исключены из опций и серверной валидации.
- На странице проекта polling списка уроков автоматически приостанавливается во время открытых модалов/алертов, чтобы выпадающие списки не закрывались из-за перерендера.
- Для скачивания аудио урока через `yt-dlp` добавлена поддержка project-level `referer`: если у проекта заполнено поле `referer`, оно передаётся в опцию `--referer` при загрузке.
- Для загрузки аудио добавлен fallback-парсер прогресса `yt-dlp`: процент теперь извлекается не только из стандартного callback библиотеки, но и из raw-вывода (`[download] ...%`), что исправляет зависание `download_progress=0` на Vimeo/HLS.
- Дефолт качества нормализации для новых уроков переключён на `low` (создание урока в проекте и legacy API создания проекта из YouTube-ссылок).
- Исправлено падение Gemini-транскрибации с `Unhandled match case true`: audio attachment для `agent()->prompt(...)` теперь передаётся как `UploadedFile` вместо `Audio::fromPath(...)`.
- На странице прогона для состояния с `failed` шагом отображается кнопка `Start` (без `Pause/Stop`), а действие `Start` теперь перезапускает прогон с первого упавшего шага и ставит его обратно в очередь.
- На странице проекта добавлена кнопка `Добавить список уроков` (после `Добавить урок`) и отдельный modal с `textarea` (10 строк): поддерживается тот же формат списка уроков, что в создании проекта, с использованием `default pipeline` проекта; при отсутствии `default pipeline` кнопка неактивна.
- На странице проекта рядом с `Добавить урок` добавлена отдельная серая кнопка `Добавить урок из аудио` и новый modal загрузки файла (drag&drop + выбор файла); сервер валидирует формат, ставит нормализацию аудио в MP3 в очередь `downloads` (job `NormalizeUploadedLessonAudioJob`) и запускает pipeline-run после успешной нормализации.
- Формат списка уроков обновлён: теперь используется пара строк `Название урока` + `https://...` (без `#`), и этот формат синхронизирован в модале создания проекта и модале добавления списка уроков в проекте.
- На странице пайплайна добавлен UI-модал редактирования шага (тип, название, описание, источник, модель, температура, промт, описание изменения) с ограничениями по типам шагов и кнопкой `Отмена` для закрытия.
- Модал редактирования шага пайплайна доработан: добавлены иконки в кнопки типа шага, иконка источника перенесена в label, в источниках разрешены `transcribe` и `text` шаги до текущего, обновлён label поля описания изменения.
- На странице пайплайна реализовано сохранение редактирования шага: кнопка `Сохранить` обновляет текущую версию шага без изменения версий, а `Сохранить новая версия` создаёт новую версию шага и копию выбранной версии пайплайна с заменой шага (номер версии пайплайна = `max+1`, текущая версия переключается только если редактировалась текущая).
- Для `draft`-шага в модале редактирования скрыты поле `Описание изменения` и кнопка `Сохранить новая версия`; обычное сохранение автоматически переводит шаг в статус `active`.
- В модале шага выбор `Шаг-источник` теперь блокируется (`disabled`) для шагов типа `transcribe`.
- Для `Сохранить новая версия` changelog новой версии пайплайна теперь формируется в виде: `- Изменения в шаге «{новое название шага}»: {Описание изменения}`.
- На странице пайплайна кнопка `Редактировать версию` открывает модал редактирования выбранной версии с полями `Название` и `Описание` (4 строки); кнопка `Сохранить` обновляет `title/description` именно у выбранной версии.
- На странице пайплайна реализовано удаление шага через отдельный `Action`: для выбранной версии создаётся новая версия пайплайна (номер `max+1`) без удалённого шага, первый шаг защищён от удаления, а зависимые шаги получают новые версии с источником из удалённого шага; changelog новой версии пополняется строками об удалении и перенастройке источников.
- Удаление шага на странице пайплайна переведено на подтверждение через alert: по клику на иконку сначала показывается предупреждение о создании новой версии пайплайна (без необратимых изменений), а фактическое удаление выполняется только по кнопке `Удалить` в alert.
- В правом блоке страницы пайплайна добавлена кнопка `Посмотреть changelog` и read-only модал просмотра changelog выбранной версии (без редактирования).
- На странице пайплайна добавлены divider-блоки с `+` после каждого шага (шаблон `twui elements/divider`) и модал добавления шага: поле источника предзаполняется ближайшим предыдущим шагом типа `text|transcribe`, сохранение создаёт новую версию пайплайна с вставленным шагом и записью в changelog `- Добавлен шаг «{название}»: {короткое описание}`, после чего UI переключается на новую версию.
- `ProjectShowPage` отрефакторен: все модальные окна/алерты вынесены в отдельные Livewire-компоненты (`ProjectShow/Modals/*`) с собственными Blade-шаблонами и собственной обработкой действий; основной `project-show-page` очищен от modal-разметки, а связь с родительской страницей переведена на события (`project-updated`, `modal-opened`, `modal-closed`).
- `PipelineShowPage` отрефакторен по тому же принципу: модальные окна/алерты вынесены в отдельные Livewire-компоненты (`PipelineShow/Modals/*`) с отдельными шаблонами, родительская страница оставлена как display/switch-компонент версий, а взаимодействие переведено на событийный обмен (`pipeline-show:*`).
- На странице пайплайна добавлена кнопка `Создать копию` (с отдельным modal flow): пользователь вводит название нового пайплайна, после чего создаётся новый `Pipeline` как копия выбранной версии (копируются описание/статус версии, шаги, их настройки и связи `input_step_id`) и выполняется переход на страницу нового пайплайна.
- На странице проекта для красной иконки неудачной загрузки аудио добавлен hover-tooltip с текстом `download_error` (если сообщение пустое, показывается fallback `Ошибка загрузки аудио`).
- В виджете очереди на главной список задач ограничен первыми 5 элементами; если задач больше, внизу отображается строка `Ещё N задач`.

## [2026-02-22] fix: мобильный перенос breadcrumbs с висячим отступом

- В `resources/views/layouts/app.blade.php` breadcrumbs переведены на mobile wrap (`flex-wrap`) с висячим левым отступом: вторая и следующие строки начинаются со сдвигом относительно первой.
- В каждом breadcrumb-элементе зафиксирована неразрывность пары `svg + text` (иконка-разделитель и текст остаются в одном `li`), при этом текстовые метки могут переноситься внутри `span/a` (`break-words`).
- Добавлен feature-тест `test_projects_index_renders_mobile_breadcrumb_wrapping_classes` в `tests/Feature/BreadcrumbsTest.php`.
- Обновлены `README.md` и `docs/next.md`.

## [2026-02-22] fix: dropdown-меню действий на странице проекта

- Статичный правый блок действий на странице проекта заменён на единый dropdown в `resources/views/pages/project-show-page.blade.php` (без дублирования mobile/desktop версии блока).
- Кнопка меню действий перенесена в заголовок страницы проекта (справа от названия) и использует ту же пару SVG-иконок (`menu/open` и `menu/close`), что и mobile-меню в основном layout.
- Слой действий сделан абсолютным и привязан к верхнему краю контейнера контента; добавлено закрытие по повторному нажатию на кнопку меню, клику вне блока и клику на любую кнопку внутри блока.
- На `md+` блок действий отображается постоянно как правая колонка страницы проекта, а кнопка открытия/закрытия меню показывается только на mobile.
- Исправлено мгновенное автозакрытие мобильного меню действий: `click.outside` больше не срабатывает на клик по самой кнопке-тогглеру.
- Адаптивная раскладка и переключение режимов для этого UI зафиксированы на брейкпоинте `md`.
- Обновлён feature-тест `tests/Feature/ProjectShowPageTest.php` и синхронизирован `tests/Feature/BreadcrumbsTest.php` под актуальные `md`-классы.
- В breadcrumbs исправлена опечатка класса `mc:pl-0` на `md:pl-0` в `resources/views/layouts/app.blade.php`.

## [2026-02-22] fix: mobile dropdown шагов на странице прогона

- На странице `projects.runs.show` добавлен mobile dropdown списка шагов между заголовком и блоком контента (`resources/views/pages/project-run-page.blade.php`).
- В закрытом состоянии dropdown показывает текущий шаг в том же формате карточки шага (название, статус, метрики) и иконку chevron.
- В открытом состоянии dropdown показывает полный список шагов с тем же форматированием и подсветкой текущего шага; выбор шага по клику вызывает `selectStep(...)` и закрывает список.
- Desktop-версия списка шагов сохранена как отдельная правая колонка (`md:block`), мобильная версия отображается только на `mobile` (`md:hidden`).
- Сетка страницы прогона синхронизирована с проектным брейкпоинтом `md` (`md:grid-cols-3`, `md:col-span-2`).
- Горизонтальные границы mobile-dropdown шагов выровнены по ширине контентного блока (убраны дополнительные `mx` у контейнера dropdown).
- Открытие mobile-dropdown шагов сделано без вертикального смещения: список рендерится абсолютным overlay от `top-0`, поэтому первый шаг перекрывает текущую закрытую карточку.
- Для mobile-dropdown шагов зафиксирована ширина выпадающего списка по ширине закрытой карточки (внутренний `relative` wrapper + `absolute w-full`), чтобы правая граница списка не уходила к краю экрана.
- В mobile-dropdown списка шагов убрана правая иконка `check` у текущего шага (текущее состояние теперь показывается только активной подсветкой карточки).
- Обновлён feature-тест `tests/Feature/ProjectRunPageTest.php` для нового mobile/dropdown UI.

## [2026-02-21] feat: переиспользование неизменённых шагов при добавлении версии пайплайна в урок

- В `PipelineRunService` добавлен сценарий создания прогона с переиспользованием префикса результатов из последнего `done`-прогона этого же урока и пайплайна.
- Переиспользование выполняется строго до первого шага с отличающимся `step_version_id`; начиная с первого несовпадения все следующие шаги создаются в статусе `pending`.
- При полном совпадении шагов новый прогон сразу создаётся как `done` (без постановки `ProcessPipelineJob` в очередь); при частичном совпадении в очередь уходит только недостающий хвост.
- Для переиспользованных шагов копируется только `result`; поля `input_tokens`, `output_tokens`, `cost`, `start_time`, `end_time` сбрасываются в нулевые значения.
- `AddPipelineVersionToLessonAction` переведён на новый сценарий создания прогона с частичным reuse.
- Добавлен unit-тест `test_it_reuses_unchanged_prefix_steps_until_first_changed_step` в `AddPipelineVersionToLessonActionTest`.
- Обновлены `README.md` и `docs/server.md` с описанием нового поведения.

## [2026-02-19] feat: упрощённая invite-аутентификация web-layer

- Добавлена миграция `2026_02_19_190000_add_access_token_and_team_user`: создаёт единственного пользователя `team@local` (если отсутствует) и поле `users.access_token`.
- Добавлен web-маршрут инвайта `GET /invite/{token}` и отдельный контроллер `AcceptInviteController`: проверяет токен, ставит постоянный cookie и редиректит на `home`.
- Добавлен middleware `AuthenticateTeamAccessToken`, который валидирует cookie-токен, авторизует пользователя в guard `web` и блокирует доступ при ошибке.
- Для неавторизованных запросов добавлена отдельная страница `resources/views/auth/access-closed.blade.php` c единственной надписью `Доступ закрыт`.
- Добавлена artisan-команда `auth:generate-invite`, генерирующая новый UUID-подобный токен и печатающая invite-ссылку для запуска через Forge.
- Добавлены feature-тесты на middleware/invite-flow и консольную команду; базовый `tests/TestCase.php` настроен на автоподстановку валидного cookie в web-тестах.
- Обновлены `README.md` и `docs/server.md` с описанием нового auth-flow и операционной команды.

## [2026-02-19] feat: экспорт результата шага в DOCX

- Добавлен сервис `PipelineStepDocxExporter` на базе `phpoffice/phpword`: конвертация Markdown через AST `league/commonmark` с поддержкой заголовков `#-###`, вложенных `ul/ol`, `bold` и `italic`.
- Для DOCX-экспорта настроены базовые стили документа: шрифт `Helvetica Neue`, базовый размер `12`, пропорциональные размеры заголовков и отступ перед заголовком.
- На странице прогона (`projects.runs.show`) добавлена кнопка `Скачать DOCX` после `Скачать MD`, подключён Livewire-экшен `downloadSelectedStepDocx`.
- На странице проекта (`projects.show`) добавлена кнопка `Скачать проект в DOCX` после `Скачать проект в MD`, а modal выбора pipeline/шага переиспользован без отдельной ветки.
- Экспорт архива результатов проекта расширен форматом `docx` в `BuildProjectStepResultsArchiveAction`: сборка ZIP выполняется тем же потоком, что для `pdf`, с формированием DOCX через `PipelineStepDocxExporter`.
- Для экспорта проекта (`PDF`/`MD`/`DOCX`) добавлен выбор именования файлов внутри ZIP (`Урок.{ext}` или `Урок - шаг.{ext}`), а имя скачиваемого ZIP упрощено до названия проекта.
- В API добавлен endpoint `GET /api/pipeline-runs/{run}/steps/{step}/export/docx` с теми же проверками принадлежности шага и наличия результата, что и в PDF/MD-экспорте.
- Добавлены тесты: feature-тест скачивания DOCX на странице прогона, feature-тест API DOCX-экспорта и unit-тест форматирования DOCX-структуры.
- Убрано добавление служебного заголовка `Урок — Шаг` в начале DOCX: экспорт теперь содержит только контент исходного Markdown шага.

## [2026-02-19] docs: уточнён статус legacy API в AGENTS

- В `AGENTS.md` зафиксировано, что `app/Http/Controllers` и `routes/api.php` — legacy-слой из периода Electron/Vue + API.
- Добавлено правило Livewire-first: новые задачи реализуем в `routes/web.php` + `app/Livewire` + `app/Services/*`.
- Отдельно прописано, что legacy API редактируется только по явному запросу, а в остальных задачах используется как референс.

## [2026-02-11] refactor: migrate LLM layer to Laravel AI SDK

- `app/Services/Llm` переписан на единый Laravel AI SDK: убраны кастомные провайдерные клиенты OpenAI/Anthropic/Gemini и их wiring в контейнере.
- `DefaultPipelineStepExecutor` переведён на `Laravel\\Ai\\Transcription` для STT и на новый `LlmManager` для текстовых шагов.
- Удалены зависимости `mozex/anthropic-laravel`, `openai-php/laravel`, `google-gemini-php/laravel`; `composer.lock` обновлён, Laravel обновлён до `12.51.0`.
- Обновлены unit-тесты LLM-слоя под новый gateway-based контракт и пересобран package manifest.
- Документация (`README.md`, `AGENTS.md`) синхронизирована с новой архитектурой LLM-интеграции.

## [2026-02-09] docs: Laravel + Livewire documentation baseline

- Полностью обновлены `AGENTS.md` и `README.md` под архитектуру Laravel + Livewire.
- Удалены legacy-упоминания desktop-слоя и старого монорепо-расположения.
- Исправлены ссылки на документацию: актуальные материалы живут в `docs/`, архив — в `docs/old/`.
- Обновлена структура changelog под standalone Laravel-репозиторий.

## [2026-01-07] feat: multi-lesson youtube projects

- Добавлен сервис `LessonDownloadManager` и эндпоинт `POST /api/projects/youtube`, который создаёт проект, уроки, стартовые `PipelineRun` и ставит загрузки в очередь.
- Логика резолва тегов вынесена в `LessonTagResolver`.
- Feature-тесты расширены под массовый сценарий создания уроков по ссылкам.

## [2026-01-06] feat: youtube lesson downloads

- Добавлен `POST /api/lessons/{lesson}/download` и джоба `DownloadLessonAudioJob`.
- Сервер скачивает аудио через `yt-dlp`, нормализует в MP3 и запускает pipeline processing.
- Добавлены события очереди загрузки (`download-started/progress/completed/failed`) для наблюдаемости.
- Добавлены feature-тесты `LessonDownloadTest`.

## [2026-01-03] fix: queue dispatch after audio upload

- Создание урока больше не запускает обработку до фактической загрузки аудио.
- `PipelineRunService::dispatchQueuedRuns()` используется после получения MP3.
- Исключены преждевременные старты прогонов без входного файла.
- Конфиги LLM обновлены: общий таймаут и лимит токенов Anthropic вынесены в `.env`.

## [2025-12-29] feat: pipeline runs and step statuses

- Добавлены сущности `PipelineRun` и `PipelineRunStep` со статусами выполнения.
- Реализованы эндпоинты очереди и перезапуска прогона с выбранного шага.
- `ProcessPipelineJob` обрабатывает шаги последовательно и устойчиво к retry-сценариям.
- Feature-тесты покрывают новый контур прогонов.

## [2025-12-24] feat: pipeline versioning and LLM abstraction

- Реализована версияция пайплайнов и шагов (`pipelines`, `pipeline_versions`, `steps`, `step_versions`, `pipeline_version_steps`).
- Добавлены API-контроллеры для управления пайплайнами, версиями и шагами.
- Внедрён слой `app/Services/Llm` с провайдерами OpenAI, Anthropic и Gemini.
- Добавлен расчёт стоимости в `LlmCostCalculator` на основе `config/pricing.php`.
- Unit и feature-тесты покрывают базовую доменную модель и LLM-провайдеры.
